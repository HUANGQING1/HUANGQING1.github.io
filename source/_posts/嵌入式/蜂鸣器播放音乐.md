---
abbrlink: 8
---
# 参考资料
```
https://zhuanlan.zhihu.com/p/102811041
https://blog.csdn.net/weixin_45344328/article/details/123748328
https://zhuanlan.zhihu.com/p/165450634
https://zhuanlan.zhihu.com/p/349054725
(https://zhuanlan.zhihu.com/p/349288830
https://baijiahao.baidu.com/s?id=1722842373056344456
```

# 乐理知识
## 唱名和音名(确定蜂鸣器频率)
### 唱名/音符

**唱名：** 唱名就是这样的do-re-mi-fa-so-la-si这样的七个音，和1234567的7个音符一一对应，常用于简谱。它们和频率有一定关系，但没有绝对的一一对应关系，此处介绍只是科普。
![](assets/蜂鸣器播放音乐.assets/音符唱名表.png)、
### 音名(确定蜂鸣器频率)
**音名：** 也就是C、C#、D、D#、E、F、F#、G、G#、A、A#、B，（C#表示在C的基础上升半音，即频率变为原来的2^(1/12)倍，每个相邻音名相差半音。bC表示在C的基础上降半音。)用于表示特定音高，**音高和蜂鸣器频率是一一对应的关系** ，音名常用于五线谱。
![](assets/蜂鸣器播放音乐.assets/image-20240125104308475.png)

具体如何对应呢，在音乐中以这样的12个音符为一组，多个组循环往复，构成乐音体系的全部乐音，当然实际音乐中所用的乐音为88个(取自钢琴琴键数量)，如图所示，国际规定小字一组的A频率为440Hz。由于相邻半音相差频率2^(1/12)倍，故可推出小字一组的C、C#、D、D#、E、F、F#、G、G#、A、A#、B频率分别为：261.63，277.18，293.66，311.13，329.63，349.23，369.99，392.00，415.30，440，466.16，493.88。其他组的频率依此类推。
由于简谱是给人歌唱的，人声音域常在小字一组，故我这里直接以小字一组频率为简谱频率。![](assets/蜂鸣器播放音乐.assets/image-20240125112919437.png)

### 简谱唱名/音符如何对应到音名(频率)（由此将简谱翻译为音名，翻译为频率）
简谱中常见1=C这样的调号，它的意思是1<--->C，2<-->D，...，7<-->B，也常见1=D,1=E这种调号。为什么要有这样的调号呢？我们知道唱名就一定是发do-re-mi-fa-so-la-si-do这样的7个音，do是哪个音高则并无规定，这里就是规定了这7个音对应的音高。这里给出它们对应关系的图片。

![](assets/蜂鸣器播放音乐.assets/f690f9795f4573fd19535244e890c22d.jpg)
do-re-mi-fa-so-la-si-do的音高差是规定好的，如上图所示，全音是两个半音。
那么1=D时，按照C、C#、D、D#、E、F、F#、G、G#、A、A#、B，以及音高差，很容易就知道2=E、3=F#、4=G、5=A、6=B、7=C#。
这样就可以将音符翻译为音名，翻译到频率(取人声音域，也就是小字一组)

## 节拍和音长(确定音符蜂鸣器演奏时长)
### 节拍

**节拍：** 简谱中有节拍的概念，拍号通常有$\frac{2}{4}、\frac{3}{4}、\frac{3}{8}、\frac{6}{8}$ 等等，$\frac{X}{Y}$表示以Y分音符的时长为一拍，每小节有X拍的时长，下图所示的就是以四分音符时长为一拍，每小节有4拍。拍速d=135表示每分钟播放135拍，也就是一拍时长是444ms。**这样每个音符时长就确定下来了**。
![](assets/蜂鸣器播放音乐.assets/节拍举例图.png)
但显然，图中每个音符到底是几拍目前是不知道的，有些音符上面有点，有些音符下面有点，有些音符下面或后面有短横线，这又是什么意思呢？
**音长：** 简谱中为了规定每个音的长短，引入了短横线和附点来描述出音长。

- 短横：在基本音符右侧加记一条短横线表示增长一个四分音符的时值。在基本音符下方加记一条短横线表示缩短原音符时值的一半。
  假设以四分音符为一拍，那么八分音符就是半拍，十六分音符就是四分之一拍，二分音符是二拍......，如下图所示。
  ![](assets/蜂鸣器播放音乐.assets/短横音符.png)

- 附点音符：附点的意义在于增长原音符时值的一半
  ![](assets/蜂鸣器播放音乐.assets/附点音符.png)
  **连线/延音线：** 简谱上的弧线叫连线/延音线(在音乐中两者定义是不同的)。每个音符演奏完需要一定停顿，一般不是连续不断的。所以在蜂鸣器中，连线/延音线都表示无需停顿，直接演奏下一音符。

  这里用蜂鸣器模拟声音，就假定是单个音长的1/10用作停顿，单个音符的音长划分为实际播放时间+停顿时间。

  ![](assets/蜂鸣器播放音乐.assets/连音线.png)
  **休止符0：** 音乐中，休止符表示无声。
# 代码编写
总的来说，一段音乐由两部分组成，频率和音长。其中音长又可分为播放时间和停顿时间。
在此以音长的1/10为停顿时间。由于是翻译简谱，简谱翻译中采用人声音域，中音小字一组，低音小字组，高音小字二组。

设计类

```
Song类：
属性：调号、拍号、拍速、简谱正文
方法：初始化函数、将正文转换为频率和时长的函数

Note类：
属性：简谱音符、音调、拍数、是否休止,是否升调
方法：初始化函数

Buzzer类：
属性：引脚
方法：播放音符函数、停止函数、延时函数

MusicPlayer类（主类）：
方法：播放歌曲函数，接收Song对象，通过Buzzer对象播放

from machine import Pin  # 假设你的蜂鸣器控制是基于MicroPython的machine库

from machine import Pin
import time

class Note:
    def __init__(self, symbol=0, beats=1, is_rest=True, pitch=0):
        """
        简谱音符的类
        :param symbol: 音符（0-7）
        :param beats: 拍数（小数），比如一拍是1，四分之一拍是0.25
        :param is_rest: 是否休止（True/False）
        :param pitch: 0（中音), 1(高音), -1(低音), ...
        """
        self.symbol = symbol
        self.beats = beats
        self.is_rest = is_rest
        self.pitch = pitch


class Song:
    def __init__(self, key="C", tempo=150, notes=None):
        """
        歌曲的类
        :param key: 调号，默认为C
        :param tempo: 拍度，默认为150
        :param notes: 简谱音符序列
        """
        self.key = key
        self.tempo = tempo
        self.notes = notes if notes else []

    def convert_to_frequency(self, note):
        """
        将简谱音符转换为频率
        :param note: 简谱音符对象
        :return: 频率
        """
        # 调号对应偏移
        key_to_offset = {'C': -9, 'D': -7, 'E': -5, 'F': -4, 'G': -2, 'A': 0, 'B': 2}
        # 音符对应偏移
        symbol_to_offset = {1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11}
        frequency = 440  # 标准音频率
        if note.symbol == 0:  # 休止符频率为0
            frequency = 0
        else:
            # 计算"C"的频率
            frequency *= 2 ** (key_to_offset[self.key] / 12)
            # 不考虑音调升降，计算该音符频率
            frequency *= 2 ** (symbol_to_offset[note.symbol] / 12)
            # 考虑音调升降
            frequency *= 2 ** note.pitch

        return frequency

    def get_duration(self, note):
        """
        根据拍数和拍度计算时长, ms
        """
        duration = int(60000 / self.tempo * note.beats)  # 转换为整数型
        return duration

    def convert_to_music_text(self):
        """
        将音符转换为音乐文本
        """
        music_text = []
        for note in self.notes:
            frequency = self.convert_to_frequency(note)
            duration = self.get_duration(note)
            is_rest = note.is_rest
            music_text.append([frequency, duration, is_rest])

        return music_text


class Buzzer:
    def __init__(self, pin=15):
        """
        蜂鸣器的类
        :param pin: 引脚，默认为15
        """
        self.pin = Pin(pin, Pin.OUT)

    def play_note(self, frequency, duration, is_rest):
        """
        播放特定频率的音符
        """
        time_ms = 0
        play_time_ms = duration
        delay_us = int(500000 / frequency)

        if is_rest:
            play_time_ms = int(duration * 0.9)

        while True:
            if time_ms < play_time_ms:
                self.pin.value(1)
                time.sleep_us(delay_us)
                self.pin.value(0)
                time.sleep_us(delay_us)
                time_ms += int(delay_us / 1000)
            elif time_ms < duration:
                self.pin.value(0)
            elif time_ms == duration:
                break


class MusicPlayer:
    def __init__(self, buzzer):
        """
        音乐播放器的类
        :param buzzer: Buzzer对象
        """
        self.buzzer = buzzer

    def play_song(self, song):
        """
        播放歌曲
        """
        for frequency, duration, is_rest in song.convert_to_music_text():
            self.buzzer.play_note(frequency, duration, is_rest)


def time0_irq(time0):
    global time_ms
    time_ms += 1  # 修正语法错误

```



```


from machine import Pin

class Beep:
    # 默认的蜂鸣器引脚为GPIO15
    BeepPin = Pin(15, Pin.OUT)

    def __init__(self, frequency, duration, is_rest=False):
        """
        初始化蜂鸣器对象。

        Parameters:
        - frequency: int, 频率表示音高。
        - duration: int, 音长表示音符持续时间us。
        - is_rest: bool, 是否是停顿。默认为 False。
        """
        self.frequency = frequency
        self.duration = duration
        self.is_rest = is_rest
  
		def play_note(self): 
			pause_us=500000/self.frequency;//取整
			self.BeepPin.value(1);
			time.sleep_us(pause_us);		
			self.BeepPin.value(0);
			time.sleep_us(pause_us);	
歌曲包含：调号，拍号，拍速，简谱正文，蜂鸣器播放正文 几部分
简谱正文：[简谱音符，拍数]
歌曲中有一个函数，输入调号和简谱音符，将得到简谱音符对应频率
歌曲中有一个函数，输入拍速和拍数，将得到拍数对应时长
歌曲有函数将正文转换为由频率和时长，是否休止构成的新正文

简谱音符包括下面几部分：简谱音符，拍数，是否休止，

蜂鸣器包括：引脚
播放音符函数：以一定频率播放音符
停止函数：停止播放
延时函数：延时指定时间
播放歌曲函数：接收由频率，时长，是否休止构成的正文，通过蜂鸣器播放出来

```
