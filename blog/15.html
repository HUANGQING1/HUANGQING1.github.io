<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
    <title>STM32学习 | 晴语的博客</title>
    
    
        <meta name="keywords" content="STM32学习">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="STM32相关软件下载与安装 下载并安装STM32CubeIDE  其他 独立按键   image-20230426085540729  串联的电容用于消除按键抖动。从这个电路中可以看出，当按键按下，电路导通，PB12直连GND，读取到的是低电平。 当按键松开，连接的是3.3v的正极，而采用浮空输入，内部有高速电阻，所以R11分的电压几乎可忽略不计，相当于直连正极，读到的是高电">
<meta property="og:type" content="article">
<meta property="og:title" content="STM32学习">
<meta property="og:url" content="http://example.com/blog/15.html">
<meta property="og:site_name" content="晴语的博客">
<meta property="og:description" content="STM32相关软件下载与安装 下载并安装STM32CubeIDE  其他 独立按键   image-20230426085540729  串联的电容用于消除按键抖动。从这个电路中可以看出，当按键按下，电路导通，PB12直连GND，读取到的是低电平。 当按键松开，连接的是3.3v的正极，而采用浮空输入，内部有高速电阻，所以R11分的电压几乎可忽略不计，相当于直连正极，读到的是高电">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/image-20230426085540729.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/%E4%B8%B2%E5%8F%A3%E6%8E%A5%E6%94%B6%E4%B8%AD%E6%96%AD%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/DMA1%E8%AF%B7%E6%B1%82%E6%98%A0%E5%83%8F.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/%E5%90%84%E4%B8%AA%E9%80%9A%E9%81%93%E7%9A%84DMA1%E8%AF%B7%E6%B1%82%E4%B8%80%E8%A7%88.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/%E5%90%84%E4%B8%AA%E9%80%9A%E9%81%93%E7%9A%84DMA2%E8%AF%B7%E6%B1%82%E4%B8%80%E8%A7%88.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/EXTI%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%9B%BE.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/IWDG%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E7%AE%80%E5%9B%BE.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/IWDG%E6%A1%86%E5%9B%BE.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/%E7%8B%AC%E7%AB%8B%E7%9C%8B%E9%97%A8%E7%8B%97%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8%E9%85%8D%E7%BD%AE%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/WWDG%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/%E7%AA%97%E5%8F%A3%E7%9C%8B%E9%97%A8%E7%8B%97%E6%A1%86%E5%9B%BE.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/SysTick%E5%AE%9A%E6%97%B6%E5%99%A8%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/SysTick%E5%AE%9A%E6%97%B6%E5%99%A8%E5%AF%84%E5%AD%98%E5%99%A8.png">
<meta property="article:published_time" content="2023-11-27T03:43:31.541Z">
<meta property="article:modified_time" content="2023-11-22T23:35:46.000Z">
<meta property="article:author" content="晴语">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/blog/assets/STM32%E5%AD%A6%E4%B9%A0.assets/image-20230426085540729.png">
    

    
        <link rel="alternate" href="/atom.xml" title="晴语的博客" type="application/atom+xml">
    

    
        <link rel="icon" href="/favicon.ico">
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">

    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
<script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">晴语的博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>categories</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            其他
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/blog/1.html">GPT_QQ机器人搭建</a></li>  <li class="file"><a href="/blog/6.html">红米9AROOT</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            嵌入式
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/blog/7.html">51单片机学习</a></li>  <li class="file"><a href="/blog/8.html">DS1621</a></li>  <li class="file"><a href="/blog/9.html">ANSG08</a></li>  <li class="file"><a href="/blog/10.html">HSU-CHM-01A温湿度传感器</a></li>  <li class="file"><a href="/blog/4.html">IIC</a></li>  <li class="file"><a href="/blog/12.html">SPI通信</a></li>  <li class="file active"><a href="/blog/15.html">STM32学习</a></li>  <li class="file"><a href="/blog/13.html">STM8S005K6T6C单片机</a></li>  <li class="file"><a href="/blog/14.html">tm1637</a></li>  <li class="file"><a href="/blog/18.html">单片机报错</a></li>  <li class="file"><a href="/blog/19.html">各类屏幕及其代码</a></li>  <li class="file"><a href="/blog/22.html">零散的嵌入式知识</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            工具软件使用
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/blog/23.html">Git</a></li>  <li class="file"><a href="/blog/2.html">Git_Hexo_Obsidian共同搭建个人博客</a></li>  <li class="file"><a href="/blog/25.html">Hexo</a></li>  <li class="file"><a href="/blog/45.html">Obsidian</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            电工电子基础
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/blog/28.html">万用表使用</a></li>  <li class="file"><a href="/blog/27.html">数字电路</a></li>  <li class="file"><a href="/blog/26.html">认识常用电子元件</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            编程语言
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            Java
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/blog/38.html">equals方法和hashCode</a></li>  <li class="file"><a href="/blog/36.html">HashMap的容量为什么必定为2的次幂</a></li>  <li class="file"><a href="/blog/37.html">Java的动态绑定和静态绑定</a></li>  <li class="file"><a href="/blog/39.html">配置Maven</a></li>  </ul> 
                    </li> 
                     </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            计算机基础
                        </a>
                         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            设计模式_Java版
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/blog/40.html">图解设计模式笔记：单例模式</a></li>  <li class="file"><a href="/blog/41.html">图解设计模式笔记：装饰器模式</a></li>  <li class="file"><a href="/blog/42.html">图解设计模式笔记：迭代器模式（Iterator）</a></li>  <li class="file"><a href="/blog/43.html">图解设计模式笔记：适配器设计模式</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/blog/11.html">KMP算法</a></li>  <li class="file"><a href="/blog/29.html">二叉树遍历与线索二叉树</a></li>  <li class="file"><a href="/blog/33.html">单片机1</a></li>  <li class="file"><a href="/blog/30.html">单片机2</a></li>  <li class="file"><a href="/blog/32.html">数据结构</a></li>  <li class="file"><a href="/blog/31.html">最小生成树算法Prim与Kruskal的证明</a></li>  <li class="file"><a href="/blog/35.html">计算机相关资源推荐</a></li>  <li class="file"><a href="/blog/34.html">计算机网络</a></li>  </ul> 
                    </li> 
                     </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-嵌入式/STM32学习" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a>
    </div>

                        
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/blog/15.html">
            <time datetime="2023-11-27T03:43:31.541Z" itemprop="datePublished">2023-11-27</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/HUANGQING1/HUANGQING1.github.io/raw/source/source/_posts/嵌入式/STM32学习.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/HUANGQING1/HUANGQING1.github.io/edit/source/source/_posts/嵌入式/STM32学习.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/HUANGQING1/HUANGQING1.github.io/commits/source/source/_posts/嵌入式/STM32学习.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            STM32学习
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <h1 id="stm32相关软件下载与安装">STM32相关软件下载与安装</h1>
<p>下载并安装STM32CubeIDE</p>
<h1 id="section"></h1>
<h1 id="其他">其他</h1>
<h2 id="独立按键">独立按键</h2>
<figure>
<img src="assets/STM32学习.assets/image-20230426085540729.png" alt="image-20230426085540729">
<figcaption aria-hidden="true">image-20230426085540729</figcaption>
</figure>
<p>串联的电容用于消除按键抖动。从这个电路中可以看出，当按键按下，电路导通，PB12直连GND，读取到的是低电平。
当按键松开，连接的是3.3v的正极，而采用浮空输入，内部有高速电阻，所以R11分的电压几乎可忽略不计，相当于直连正极，读到的是高电平。
如果采用上拉输入，相当于内部接了上拉电阻，此处的上拉电阻可以省略。</p>
<p>HAL_GPIO_ReadPin()</p>
<p>GPIO_PinState是高电平和低电平状态的枚举类型
HAL_GPIO_TogglePin（）翻转输出电平</p>
<p>Ctrl+鼠标点击，可查看函数实现 浮空输入，内部有高电阻</p>
<h1 id="gpio">GPIO</h1>
<h2 id="种gpio模式">8种GPIO模式</h2>
<h2 id="使用gpio的基本步骤">使用GPIO的基本步骤</h2>
<ul>
<li><p>配置GPIO引脚的时钟使能。(stm32为实现低功耗，所有外设时钟默认不使能)</p></li>
<li><p>配置输入输出模式：输入/推挽或开漏输出、输出速度、上拉/下拉，输入输出速度。然后初始化引脚</p></li>
<li><p>使用GPIO'</p></li>
</ul>
<h1 id="使用uart的基本步骤">使用UART的基本步骤</h1>
<p>串行通信方式，RS232电平。异步通信通过帧发送，帧由起始位，数据位，奇偶校验位，停止位构成，通过波特率和起始位保证通信双方接发同步。有Rx,Tx两条数据线。</p>
<ul>
<li>配置UART的GPIO引脚
<ul>
<li>使能GPIO和UART的时钟</li>
<li>配置GPIO引脚为复用功能等</li>
<li>配置GPIO引脚的复用映射到UART的收发引脚</li>
</ul></li>
<li>配置UART的波特率、数据位、等等信息</li>
<li>配置UART的发送和接收方式
<ul>
<li>配置UART的发送和接收中断（可选，配置中断向量表，开中断）</li>
<li>或者轮询方式进行发送和接收（主循环中轮询）</li>
</ul></li>
<li>使能UART</li>
</ul>
<h2 id="uart代码">UART代码</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">//UART HAL库代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#include &quot;stm32f1xx_hal.h&quot;  </span><br><span class="line">#include &quot;stdio.h&quot;	</span><br><span class="line"></span><br><span class="line">//重定向printf函数</span><br><span class="line">#if 1</span><br><span class="line">#pragma import(__use_no_semihosting)             </span><br><span class="line">//标准库需要的支持函数                 </span><br><span class="line">struct __FILE </span><br><span class="line">&#123; </span><br><span class="line">	int handle; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">FILE __stdout;       </span><br><span class="line">//定义_sys_exit()以避免使用半主机模式    </span><br><span class="line">void _sys_exit(int x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line">//重定义fputc函数 </span><br><span class="line">int fputc(int ch, FILE *f)</span><br><span class="line">&#123;      </span><br><span class="line">	while((USART1-&gt;SR&amp;0X40)==0);//循环发送,直到发送完毕   </span><br><span class="line">    USART1-&gt;DR = (unsigned char) ch;      </span><br><span class="line">	return ch;</span><br><span class="line">&#125;</span><br><span class="line">#endif </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uint8_t TxBuf[]=&quot;Hello World&quot;;//HAL库使用的串口接收缓冲</span><br><span class="line">UART_HandleTypeDef UART1_Handler; //UART句柄</span><br><span class="line">void MX_USART1_UART_Init(void);  </span><br><span class="line">void HAL_UART_MspInit(UART_HandleTypeDef *huart);</span><br><span class="line">void SystemClock_Config(void);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123; </span><br><span class="line">	</span><br><span class="line">	HAL_Init();                    	 	//初始化HAL库    </span><br><span class="line">	SystemClock_Config();   	//设置时钟,72M</span><br><span class="line">	MX_USART1_UART_Init();					//初始化串口	</span><br><span class="line">	while (1)</span><br><span class="line">	&#123;</span><br><span class="line">		HAL_Delay(100);</span><br><span class="line">		HAL_UART_Transmit(&amp;UART1_Handler, TxBuf, sizeof(TxBuf), 100);</span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">时钟部分代码</span><br><span class="line">****************************/</span><br><span class="line">//系统时钟时钟</span><br><span class="line">void SystemClock_Config(void)</span><br><span class="line">&#123;</span><br><span class="line">	RCC_OscInitTypeDef RCC_OscInitStructure; </span><br><span class="line">	RCC_ClkInitTypeDef RCC_ClkInitStructure;</span><br><span class="line"></span><br><span class="line">	RCC_OscInitStructure.OscillatorType=RCC_OSCILLATORTYPE_HSE;    	//时钟源为HSE</span><br><span class="line">	RCC_OscInitStructure.HSEState=RCC_HSE_ON;                      	//打开HSE</span><br><span class="line">	RCC_OscInitStructure.HSEPredivValue=RCC_HSE_PREDIV_DIV1;		//HSE预分频</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLState=RCC_PLL_ON;					//打开PLL</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLSource=RCC_PLLSOURCE_HSE;			//PLL时钟源选择HSE</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLMUL=RCC_PLL_MUL9; 							//主PLL倍频因子</span><br><span class="line"></span><br><span class="line">	if(HAL_RCC_OscConfig(&amp;RCC_OscInitStructure)!=HAL_OK) &#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//选中PLL作为系统时钟源并且配置HCLK,PCLK1和PCLK2</span><br><span class="line">	RCC_ClkInitStructure.ClockType=(RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2);</span><br><span class="line">	RCC_ClkInitStructure.SYSCLKSource=RCC_SYSCLKSOURCE_PLLCLK;		//设置系统时钟时钟源为PLL</span><br><span class="line">	RCC_ClkInitStructure.AHBCLKDivider=RCC_SYSCLK_DIV1;				//AHB分频系数为1</span><br><span class="line">	RCC_ClkInitStructure.APB1CLKDivider=RCC_HCLK_DIV2; 				//APB1分频系数为2</span><br><span class="line">	RCC_ClkInitStructure.APB2CLKDivider=RCC_HCLK_DIV1; 				//APB2分频系数为1</span><br><span class="line">	</span><br><span class="line">	if (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStructure,FLASH_LATENCY_2) != HAL_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">串口部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">//初始化IO 串口1 </span><br><span class="line">void MX_USART1_UART_Init()</span><br><span class="line">&#123;	</span><br><span class="line">	//UART 初始化设置</span><br><span class="line">	UART1_Handler.Instance=USART1;					   	 //USART1</span><br><span class="line">	UART1_Handler.Init.BaudRate=115200;				    //波特率</span><br><span class="line">	UART1_Handler.Init.WordLength=UART_WORDLENGTH_8B;   //字长为8位数据格式</span><br><span class="line">	UART1_Handler.Init.StopBits=UART_STOPBITS_1;	    //一个停止位</span><br><span class="line">	UART1_Handler.Init.Parity=UART_PARITY_NONE;		    //无奇偶校验位</span><br><span class="line">	UART1_Handler.Init.HwFlowCtl=UART_HWCONTROL_NONE;   //无硬件流控</span><br><span class="line">	UART1_Handler.Init.Mode=UART_MODE_TX_RX;		    //收发模式</span><br><span class="line">	HAL_UART_Init(&amp;UART1_Handler);					    //HAL_UART_Init()会使能UART1</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//UART底层初始化，时钟使能，引脚配置，中断配置</span><br><span class="line">//此函数会被HAL_UART_Init()调用</span><br><span class="line">void HAL_UART_MspInit(UART_HandleTypeDef *huart)//huart:串口句柄</span><br><span class="line">&#123;</span><br><span class="line">    //GPIO端口设置</span><br><span class="line">	GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">	</span><br><span class="line">	if(huart-&gt;Instance==USART1)//如果是串口1，进行串口1 MSP初始化</span><br><span class="line">	&#123;</span><br><span class="line">		__HAL_RCC_GPIOA_CLK_ENABLE();			//使能GPIOA时钟</span><br><span class="line">		__HAL_RCC_USART1_CLK_ENABLE();			//使能USART1时钟</span><br><span class="line">		__HAL_RCC_AFIO_CLK_ENABLE();</span><br><span class="line">	</span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_9;			//PA9</span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_PP;		//复用推挽输出</span><br><span class="line">		GPIO_Initure.Pull=GPIO_PULLUP;			//上拉</span><br><span class="line">		GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;//高速</span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);	   	//初始化PA9</span><br><span class="line"></span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_10;			//PA10</span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_INPUT;	//模式要设置为复用输入模式！	</span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);	   	//初始化PA10</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">// UART 标准库代码</span><br><span class="line">//将串口接收的数据原样返回</span><br><span class="line"></span><br><span class="line">#include &quot;stm32f10x.h&quot;	</span><br><span class="line">#include &quot;stm32f10x_usart.h&quot;</span><br><span class="line">#include &quot;stdio.h&quot;</span><br><span class="line">//重定向printf函数</span><br><span class="line">#if 1</span><br><span class="line">#pragma import(__use_no_semihosting)             </span><br><span class="line">//标准库需要的支持函数                 </span><br><span class="line">struct __FILE </span><br><span class="line">&#123; </span><br><span class="line">	int handle; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">FILE __stdout;       </span><br><span class="line">//定义_sys_exit()以避免使用半主机模式    </span><br><span class="line">void _sys_exit(int x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line">//重定义fputc函数 </span><br><span class="line">int fputc(int ch, FILE *f)</span><br><span class="line">&#123;      </span><br><span class="line">	while((USART1-&gt;SR&amp;0X40)==0);//循环发送,直到发送完毕   </span><br><span class="line">    USART1-&gt;DR = (unsigned char) ch;      </span><br><span class="line">	return ch;</span><br><span class="line">&#125;</span><br><span class="line">#endif </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void GPIO_Configuration(void);</span><br><span class="line">void USART_Configuration(u32 bound);</span><br><span class="line">void RCC_Configuration(void);</span><br><span class="line">int main(void)</span><br><span class="line">&#123;	</span><br><span class="line">	RCC_Configuration();</span><br><span class="line">	GPIO_Configuration();</span><br><span class="line">	USART_Configuration(9600);</span><br><span class="line"> </span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		if(USART_GetFlagStatus(USART1,USART_FLAG_RXNE)==SET)</span><br><span class="line">		&#123;</span><br><span class="line">			USART_SendData(USART1,USART_ReceiveData(USART1));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">时钟部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">void RCC_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">	ErrorStatus HSEStartUpStatus;//定义枚举型变量HSEStartUpStatus</span><br><span class="line">	RCC_DeInit();//复位系统时钟设置</span><br><span class="line">	RCC_HSEConfig(RCC_HSE_ON);//开启HSE</span><br><span class="line">	HSEStartUpStatus=RCC_WaitForHSEStatusUp();//等待HSE起振并稳定</span><br><span class="line">	if(HSEStartUpStatus==SUCCESS)//判断HSE是否起振成功，是则进入if内部</span><br><span class="line">	&#123;</span><br><span class="line">		RCC_HCLKConfig(RCC_SYSCLK_Div1);//选择HCLK(AHB)时钟源为SYSCLK 1 分频</span><br><span class="line">		RCC_PCLK2Config(RCC_HCLK_Div1);//选择PCLK2时钟源为HCLK(AHB) 1 分频</span><br><span class="line">		RCC_PCLK1Config(RCC_HCLK_Div2);//选择PCLK1时钟源为HCLK(AHB) 2 分频</span><br><span class="line">		FLASH_SetLatency(FLASH_Latency_2);//设置FLASH延时周期数为2</span><br><span class="line">		FLASH_PrefetchBufferCmd(FLASH_PrefetchBuffer_Enable);//使能FLASH预取缓存</span><br><span class="line">		RCC_PLLConfig(RCC_PLLSource_HSE_Div1,RCC_PLLMul_9);//选择锁相环(PLL)时钟源为HSE 1 分频，倍频数为9，则PLL输出频率为 8MHz*9=72MHz</span><br><span class="line">		RCC_PLLCmd(ENABLE);//使能PLL</span><br><span class="line">		while(RCC_GetFlagStatus(RCC_FLAG_PLLRDY)==RESET);//等待PLL输出稳定</span><br><span class="line">		RCC_SYSCLKConfig(RCC_SYSCLKSource_PLLCLK);//选择SYSCLK时钟源为PLL</span><br><span class="line">		while(RCC_GetSYSCLKSource()!=0x08);//等待PLL成为SYSCLK时钟源</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1|RCC_APB2Periph_GPIOA, ENABLE);	//使能USART1，GPIOA时钟</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">串口部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">//初始化IO 串口1 </span><br><span class="line">void GPIO_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">  //GPIO端口设置</span><br><span class="line">  GPIO_InitTypeDef GPIO_InitStructure; </span><br><span class="line">	  </span><br><span class="line">	//USART1_TX   GPIOA.9</span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9; //PA.9</span><br><span class="line">  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;	//复用推挽输出</span><br><span class="line">  GPIO_Init(GPIOA, &amp;GPIO_InitStructure);//初始化GPIOA.9</span><br><span class="line">   </span><br><span class="line">  //USART1_RX	  GPIOA.10初始化</span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;//PA10</span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;//浮空输入</span><br><span class="line">  GPIO_Init(GPIOA, &amp;GPIO_InitStructure);//初始化GPIOA.10  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//UART底层初始化，时钟使能，引脚配置，中断配置</span><br><span class="line">void USART_Configuration(u32 bound)&#123;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   //USART 初始化设置</span><br><span class="line"></span><br><span class="line">	USART_InitStructure.USART_BaudRate = bound;//串口波特率</span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;//字长为8位数据格式</span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;//一个停止位</span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;//无奇偶校验位</span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;//无硬件数据流控制</span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	//收发模式</span><br><span class="line"></span><br><span class="line">  USART_Init(USART1, &amp;USART_InitStructure); //初始化串口1</span><br><span class="line">  USART_Cmd(USART1, ENABLE);                    //使能串口1 </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="uart中断接收">UART中断接收</h2>
<figure>
<img src="assets/STM32学习.assets/串口接收中断流程.png" alt="串口接收中断流程">
<figcaption aria-hidden="true">串口接收中断流程</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">//这只是最简单的中断接收程序，故不能保证接收的数据无误等。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#include &quot;stm32f1xx_hal.h&quot;  </span><br><span class="line">#include &quot;stdio.h&quot;	</span><br><span class="line"></span><br><span class="line">//重定向printf函数</span><br><span class="line">#if 1</span><br><span class="line">#pragma import(__use_no_semihosting)             </span><br><span class="line">//标准库需要的支持函数                 </span><br><span class="line">struct __FILE </span><br><span class="line">&#123; </span><br><span class="line">	int handle; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">FILE __stdout;       </span><br><span class="line">//定义_sys_exit()以避免使用半主机模式    </span><br><span class="line">void _sys_exit(int x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line">//重定义fputc函数 </span><br><span class="line">int fputc(int ch, FILE *f)</span><br><span class="line">&#123;      </span><br><span class="line">	while((USART1-&gt;SR&amp;0X40)==0);//循环发送,直到发送完毕   </span><br><span class="line">    USART1-&gt;DR = (unsigned char) ch;      </span><br><span class="line">	return ch;</span><br><span class="line">&#125;</span><br><span class="line">#endif </span><br><span class="line"></span><br><span class="line">unsigned char aRxBuffer[10];//HAL库使用的串口接收缓冲</span><br><span class="line">UART_HandleTypeDef UART1_Handler; //UART句柄</span><br><span class="line">void MX_USART1_UART_Init(void);  </span><br><span class="line">void HAL_UART_MspInit(UART_HandleTypeDef *huart);</span><br><span class="line">void SystemClock_Config(void);</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123; </span><br><span class="line">    HAL_Init();                  //初始化HAL库    </span><br><span class="line">    SystemClock_Config();   	//设置时钟,72M</span><br><span class="line">    MX_USART1_UART_Init();					//初始化串口	</span><br><span class="line">    while(1);			</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">时钟部分代码</span><br><span class="line">****************************/</span><br><span class="line">//系统时钟时钟</span><br><span class="line">void SystemClock_Config(void)</span><br><span class="line">&#123;</span><br><span class="line">	RCC_OscInitTypeDef RCC_OscInitStructure; </span><br><span class="line">	RCC_ClkInitTypeDef RCC_ClkInitStructure;</span><br><span class="line"></span><br><span class="line">	RCC_OscInitStructure.OscillatorType=RCC_OSCILLATORTYPE_HSE;    	//时钟源为HSE</span><br><span class="line">	RCC_OscInitStructure.HSEState=RCC_HSE_ON;                      	//打开HSE</span><br><span class="line">	RCC_OscInitStructure.HSEPredivValue=RCC_HSE_PREDIV_DIV1;		//HSE预分频</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLState=RCC_PLL_ON;					//打开PLL</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLSource=RCC_PLLSOURCE_HSE;			//PLL时钟源选择HSE</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLMUL=RCC_PLL_MUL9; 							//主PLL倍频因子</span><br><span class="line"></span><br><span class="line">	if(HAL_RCC_OscConfig(&amp;RCC_OscInitStructure)!=HAL_OK) &#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//选中PLL作为系统时钟源并且配置HCLK,PCLK1和PCLK2</span><br><span class="line">	RCC_ClkInitStructure.ClockType=(RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2);</span><br><span class="line">	RCC_ClkInitStructure.SYSCLKSource=RCC_SYSCLKSOURCE_PLLCLK;		//设置系统时钟时钟源为PLL</span><br><span class="line">	RCC_ClkInitStructure.AHBCLKDivider=RCC_SYSCLK_DIV1;				//AHB分频系数为1</span><br><span class="line">	RCC_ClkInitStructure.APB1CLKDivider=RCC_HCLK_DIV2; 				//APB1分频系数为2</span><br><span class="line">	RCC_ClkInitStructure.APB2CLKDivider=RCC_HCLK_DIV1; 				//APB2分频系数为1</span><br><span class="line">	</span><br><span class="line">	if (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStructure,FLASH_LATENCY_2) != HAL_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">串口部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">//初始化IO 串口1 </span><br><span class="line">void MX_USART1_UART_Init()</span><br><span class="line">&#123;	</span><br><span class="line">	//UART 初始化设置</span><br><span class="line">	UART1_Handler.Instance=USART1;					   	 //USART1</span><br><span class="line">	UART1_Handler.Init.BaudRate=115200;				    //波特率</span><br><span class="line">	UART1_Handler.Init.WordLength=UART_WORDLENGTH_8B;   //字长为8位数据格式</span><br><span class="line">	UART1_Handler.Init.StopBits=UART_STOPBITS_1;	    //一个停止位</span><br><span class="line">	UART1_Handler.Init.Parity=UART_PARITY_NONE;		    //无奇偶校验位</span><br><span class="line">	UART1_Handler.Init.HwFlowCtl=UART_HWCONTROL_NONE;   //无硬件流控</span><br><span class="line">	UART1_Handler.Init.Mode=UART_MODE_TX_RX;		    //收发模式</span><br><span class="line">	HAL_UART_Init(&amp;UART1_Handler);					    //HAL_UART_Init()会使能UART1</span><br><span class="line">	</span><br><span class="line">	HAL_UART_Receive_IT(&amp;UART1_Handler, (unsigned char *)aRxBuffer,sizeof(aRxBuffer));//该函数会开启接收中断：标志位UART_IT_RXNE，并且设置接收缓冲以及接收缓冲接收最大数据量  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//UART底层初始化，时钟使能，引脚配置，中断配置</span><br><span class="line">//此函数会被HAL_UART_Init()调用</span><br><span class="line">void HAL_UART_MspInit(UART_HandleTypeDef *huart)//huart:串口句柄</span><br><span class="line">&#123;</span><br><span class="line">    //GPIO端口设置</span><br><span class="line">	GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">	</span><br><span class="line">	if(huart-&gt;Instance==USART1)//如果是串口1，进行串口1 MSP初始化</span><br><span class="line">	&#123;</span><br><span class="line">		__HAL_RCC_GPIOA_CLK_ENABLE();			//使能GPIOA时钟</span><br><span class="line">		__HAL_RCC_USART1_CLK_ENABLE();			//使能USART1时钟</span><br><span class="line">		__HAL_RCC_AFIO_CLK_ENABLE();</span><br><span class="line">	</span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_9;			//PA9</span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_PP;		//复用推挽输出</span><br><span class="line">		GPIO_Initure.Pull=GPIO_PULLUP;			//上拉</span><br><span class="line">		GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;//高速</span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);	   	//初始化PA9</span><br><span class="line"></span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_10;			//PA10</span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_INPUT;	//模式要设置为复用输入模式！	</span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);	   	//初始化PA10</span><br><span class="line">		</span><br><span class="line">		HAL_NVIC_EnableIRQ(USART1_IRQn);				//使能USART1中断通道</span><br><span class="line">		HAL_NVIC_SetPriority(USART1_IRQn,3,3);			//抢占优先级3，子优先级3</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">/***************************</span><br><span class="line">中断部分代码</span><br><span class="line">****************************/</span><br><span class="line">//当串口接收到信号，会触发串口中断，调用USART1_IRQHandler函数</span><br><span class="line">//HAL_UART_IRQHandler函数会判断是否为该USART口发生USART中断，如果发生，执行该函数	</span><br><span class="line">//HAL_UART_IRQHandler函数中会一根还是，这个函数又会调用HAL_UART_RxCpltCallback函数，实际上HAL_UART_RxCpltCallback函数才是真正的编写中断服务程序的函数。</span><br><span class="line">//HAL_UART_Receive_IT的作用是开启中断，设置接收缓冲以及接收缓冲接收最大数据量 。</span><br><span class="line">//当接收了HAL_UART_Receive_IT中指定数目字节数据后，HAL_UART_RxCpltCallback才会被触发一次</span><br><span class="line"></span><br><span class="line">void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)</span><br><span class="line">&#123;</span><br><span class="line">	if(huart-&gt;Instance==USART1)//如果是串口1</span><br><span class="line">	&#123;</span><br><span class="line">		printf(&quot;您收到的数据是：&quot;);</span><br><span class="line">		if(HAL_UART_Transmit(&amp;UART1_Handler, (uint8_t *)aRxBuffer, sizeof(aRxBuffer), 5000) != HAL_OK)</span><br><span class="line">		&#123;</span><br><span class="line">		// Error_Handler();  // Error handling function</span><br><span class="line">		&#125;</span><br><span class="line">		printf(&quot;\r\n&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">//串口1中断服务程序</span><br><span class="line">void USART1_IRQHandler(void)                	</span><br><span class="line">&#123; </span><br><span class="line">	HAL_UART_IRQHandler(&amp;UART1_Handler);	//调用HAL库中断处理公用函数</span><br><span class="line">	HAL_UART_Receive_IT(&amp;UART1_Handler, (unsigned char *)aRxBuffer,sizeof(aRxBuffer)) ;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">// UART 标准库代码</span><br><span class="line"></span><br><span class="line">#include &quot;stm32f10x.h&quot;	</span><br><span class="line">#include &quot;stm32f10x_usart.h&quot;</span><br><span class="line">#include &quot;stdio.h&quot;</span><br><span class="line">//重定向printf函数</span><br><span class="line">#if 1</span><br><span class="line">#pragma import(__use_no_semihosting)             </span><br><span class="line">//标准库需要的支持函数                 </span><br><span class="line">struct __FILE </span><br><span class="line">&#123; </span><br><span class="line">	int handle; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">FILE __stdout;       </span><br><span class="line">//定义_sys_exit()以避免使用半主机模式    </span><br><span class="line">void _sys_exit(int x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line">//重定义fputc函数 </span><br><span class="line">int fputc(int ch, FILE *f)</span><br><span class="line">&#123;      </span><br><span class="line">	while((USART1-&gt;SR&amp;0X40)==0);//循环发送,直到发送完毕   </span><br><span class="line">    USART1-&gt;DR = (unsigned char) ch;      </span><br><span class="line">	return ch;</span><br><span class="line">&#125;</span><br><span class="line">#endif </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void NVIC_Configuration(void);</span><br><span class="line">void GPIO_Configuration(void);</span><br><span class="line">void USART_Configuration(u32 bound);</span><br><span class="line">void RCC_Configuration(void);</span><br><span class="line">int main(void)</span><br><span class="line">&#123;	</span><br><span class="line">	RCC_Configuration();</span><br><span class="line">	GPIO_Configuration();</span><br><span class="line">	 NVIC_Configuration();</span><br><span class="line">	USART_Configuration(9600);</span><br><span class="line">	</span><br><span class="line"> </span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;	 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">时钟部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">void RCC_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1|RCC_APB2Periph_GPIOA, ENABLE);	//使能USART1，GPIOA时钟</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">串口部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">//初始化IO 串口1 </span><br><span class="line">void GPIO_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">  //GPIO端口设置</span><br><span class="line">  GPIO_InitTypeDef GPIO_InitStructure; </span><br><span class="line">	  </span><br><span class="line">	//USART1_TX   GPIOA.9</span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9; //PA.9</span><br><span class="line">  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;	//复用推挽输出</span><br><span class="line">  GPIO_Init(GPIOA, &amp;GPIO_InitStructure);//初始化GPIOA.9</span><br><span class="line">   </span><br><span class="line">  //USART1_RX	  GPIOA.10初始化</span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;//PA10</span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;//浮空输入</span><br><span class="line">  GPIO_Init(GPIOA, &amp;GPIO_InitStructure);//初始化GPIOA.10  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//UART底层初始化，时钟使能，引脚配置，中断配置</span><br><span class="line">void USART_Configuration(u32 bound)&#123;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   //USART 初始化设置</span><br><span class="line"></span><br><span class="line">	USART_InitStructure.USART_BaudRate = bound;//串口波特率</span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;//字长为8位数据格式</span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;//一个停止位</span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;//无奇偶校验位</span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;//无硬件数据流控制</span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	//收发模式</span><br><span class="line"></span><br><span class="line">  USART_Init(USART1, &amp;USART_InitStructure); //初始化串口1</span><br><span class="line">  USART_Cmd(USART1, ENABLE);                    //使能串口1 </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">中断部分代码</span><br><span class="line">****************************/</span><br><span class="line">void NVIC_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">NVIC_InitTypeDef NVIC_InitStructure;</span><br><span class="line">  //Usart1 NVIC 配置</span><br><span class="line">  NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=3 ;//抢占优先级3</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;		//子优先级3</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;			//IRQ通道使能</span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);	//根据指定的参数初始化VIC寄存器</span><br><span class="line">	</span><br><span class="line">	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);</span><br><span class="line">	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);//开启串口接受中断</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//USART_GetFlagStatus(USART1,USART_FLAG_RXNE)与USART_GetITStatus(USART1,USART_IT_RXNE)使用起来是一样的</span><br><span class="line">void USART1_IRQHandler(void)                	//串口1中断服务程序</span><br><span class="line">&#123;</span><br><span class="line">	if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)  //接收中断(接收到的数据必须是0x0d 0x0a结尾)</span><br><span class="line">	&#123;</span><br><span class="line">			USART_SendData(USART1,USART_ReceiveData(USART1)); </span><br><span class="line">			USART_ClearITPendingBit(USART1,USART_IT_RXNE);</span><br><span class="line">	 &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="dma">DMA</h1>
<p>DMA(Direct Memory
Access)直接存储器访问，将数据从一个地址空间复制到另一个地址空间，提供在外设和存储器之间或者存储器和存储器之间的高速数据传输。DMA传输方式无需CPU直接控制传输，也没有中断处理方式那样保留现场和恢复现场过程，使得CPU的效率大大提高。</p>
<p>STM32 最多有 2 个 DMA 控制器（ DMA2
仅存在大容量产品和互联型产品中），12个独立的可配置的通道(请求)， DMA1 有
7 个通道。DMA2 有 5
个通道。每个通道专门用来管理来自于一个或多个外设对存储器访问的请求。还有一个仲裁器来协调各个
DMA 请求的优先权。</p>
<figure>
<img src="assets/STM32学习.assets/DMA1请求映像.png" alt="DMA1请求映像">
<figcaption aria-hidden="true">DMA1请求映像</figcaption>
</figure>
<p><img src="assets/STM32学习.assets/各个通道的DMA1请求一览.png" alt="各个通道的DMA1请求一览"> <img src="assets/STM32学习.assets/DMA2请求映像.png" alt="DMA2请求映像"></p>
<figure>
<img src="assets/STM32学习.assets/各个通道的DMA2请求一览.png" alt="各个通道的DMA2请求一览">
<figcaption aria-hidden="true">各个通道的DMA2请求一览</figcaption>
</figure>
<ul>
<li><p>DMA常用库函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DMA_DeInit(DMA1_Channel6);											//将DMA的通道6寄存器重设为缺省值 </span><br><span class="line">DMA_Init(DMA1_Channel6,&amp;DMA1_Init); 								//对DMA通道6进行初始化	</span><br><span class="line">DMA_ITConfig(DMA1_Channel6,DMA_IT_TC|DMA_IT_HT,ENABLE);						//使能DMA通道6的传输完成中断和半传输中断</span><br><span class="line">DMA_Cmd(DMA1_Channel6,ENABLE);           							//使DMA通道6开始工作</span><br><span class="line">USART_DMACmd(USART2, USART_DMAReq_Rx, ENABLE);        				//开启串口DMA接收</span><br><span class="line">u16 CurrDataCount=DMA_GetCurrDataCounte(DMA1_Channel6) //获取DMA通道当前剩余的待传输数据数目</span><br><span class="line">DMA_GetITStatus(DMA_IT_TC6)!=RESET //查询DMA的通道6是否已经传输完成，产生传输完成中断</span><br><span class="line">DMA_ClearITPendingBit(DMA_IT_TC6);//清除DMA通道6的传输完成中断</span><br></pre></td></tr></table></figure></li>
<li><p>使用DMA基本步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DMA中约定了源地址和目的地址，以及需要搬运的数据大小(存放于计数器中)后，使能对应的DMA通道，会开始搬运数据，每搬运完成一个字节，计数器减1，传输完成中断置位</span><br></pre></td></tr></table></figure>
<ul>
<li>配置RCC寄存器，打开DMA时钟，一般挂载在AHB上</li>
<li>配置NVIC，比如给予DMA传输完成中断0级抢占优先级</li>
<li>配置DMA寄存器各个参数</li>
</ul></li>
</ul>
<h2 id="dma串口收发代码">DMA串口收发代码</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><span class="line">// UART 标准库代码</span><br><span class="line"></span><br><span class="line">#include &quot;stm32f10x.h&quot;	</span><br><span class="line">#include &quot;stm32f10x_usart.h&quot;</span><br><span class="line">#include &quot;stdio.h&quot;</span><br><span class="line">//重定向printf函数</span><br><span class="line">#if 1</span><br><span class="line">#pragma import(__use_no_semihosting)             </span><br><span class="line">//标准库需要的支持函数                 </span><br><span class="line">struct __FILE </span><br><span class="line">&#123; </span><br><span class="line">	int handle; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">FILE __stdout;       </span><br><span class="line">//定义_sys_exit()以避免使用半主机模式    </span><br><span class="line">void _sys_exit(int x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line">//重定义fputc函数 </span><br><span class="line">int fputc(int ch, FILE *f)</span><br><span class="line">&#123;      </span><br><span class="line">	while((USART1-&gt;SR&amp;0X40)==0);//循环发送,直到发送完毕   </span><br><span class="line">    USART1-&gt;DR = (unsigned char) ch;      </span><br><span class="line">	return ch;</span><br><span class="line">&#125;</span><br><span class="line">#endif </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//USART2_MAX_TX_LEN和USART2_MAX_RX_LEN在头文件进行了宏定义，分别指USART2最大发送长度和最大接收长度</span><br><span class="line">u8 USART2_TX_BUF[USART2_MAX_TX_LEN]; 	//发送缓冲,最大USART2_MAX_TX_LEN字节</span><br><span class="line">u8 u1rxbuf[USART2_MAX_RX_LEN];			//发送数据缓冲区1</span><br><span class="line">u8 u2rxbuf[USART2_MAX_RX_LEN];			//发送数据缓冲区2</span><br><span class="line">u8 witchbuf=0;                  		//标记当前使用的是哪个缓冲区,0：使用u1rxbuf；1：使用u2rxbuf</span><br><span class="line">u8 USART2_TX_FLAG=0;					//USART2发送标志，启动发送时置1</span><br><span class="line">u8 USART2_RX_FLAG=0;					//USART2接收标志，启动接收时置1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void NVIC_Configuration(void);</span><br><span class="line">void GPIO_Configuration(void);</span><br><span class="line">void USART_Configuration(u32 bound);</span><br><span class="line">void RCC_Configuration(void);</span><br><span class="line">void DMA_Configuration(void);</span><br><span class="line">int main(void)</span><br><span class="line">&#123;	</span><br><span class="line">	RCC_Configuration();</span><br><span class="line">	GPIO_Configuration();</span><br><span class="line">	 NVIC_Configuration();</span><br><span class="line">	USART_Configuration(9600);</span><br><span class="line">	</span><br><span class="line"> </span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;	 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">时钟部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">void RCC_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1|RCC_APB2Periph_GPIOA, ENABLE);	//使能USART1，GPIOA时钟</span><br><span class="line">	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1,ENABLE);						//使能DMA1时钟</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">串口部分代码</span><br><span class="line">****************************/</span><br><span class="line"></span><br><span class="line">//初始化IO 串口1 </span><br><span class="line">void GPIO_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">  //GPIO端口设置</span><br><span class="line">  GPIO_InitTypeDef GPIO_InitStructure; </span><br><span class="line">	  </span><br><span class="line">	//USART1_TX   GPIOA.9</span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9; //PA.9</span><br><span class="line">  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;	//复用推挽输出</span><br><span class="line">  GPIO_Init(GPIOA, &amp;GPIO_InitStructure);//初始化GPIOA.9</span><br><span class="line">   </span><br><span class="line">  //USART1_RX	  GPIOA.10初始化</span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;//PA10</span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;//浮空输入</span><br><span class="line">  GPIO_Init(GPIOA, &amp;GPIO_InitStructure);//初始化GPIOA.10  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//UART底层初始化，时钟使能，引脚配置，中断配置</span><br><span class="line">void USART_Configuration(u32 bound)&#123;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   //USART 初始化设置</span><br><span class="line"></span><br><span class="line">	USART_InitStructure.USART_BaudRate = bound;//串口波特率</span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;//字长为8位数据格式</span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;//一个停止位</span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;//无奇偶校验位</span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;//无硬件数据流控制</span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	//收发模式</span><br><span class="line"></span><br><span class="line">    USART_ITConfig(USART2, USART_IT_IDLE, ENABLE);									//开启检测串口空闲状态中断</span><br><span class="line">    USART_ClearFlag(USART2,USART_FLAG_TC);											//清除USART2标志位</span><br><span class="line">    USART_Init(USART1, &amp;USART_InitStructure); //初始化串口1</span><br><span class="line">    USART_Cmd(USART1, ENABLE);                    //使能串口1 </span><br><span class="line"></span><br><span class="line">    USART_DMACmd(USART2, USART_DMAReq_Tx, ENABLE);        					//开启串口DMA发送</span><br><span class="line">    USART_DMACmd(USART2, USART_DMAReq_Rx, ENABLE);        					//开启串口DMA接收</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">中断部分代码</span><br><span class="line">****************************/</span><br><span class="line">void NVIC_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">NVIC_InitTypeDef NVIC_InitStructure;</span><br><span class="line">    //Usart1 NVIC 配置</span><br><span class="line">    NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;</span><br><span class="line">    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=3 ;//抢占优先级3</span><br><span class="line">    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;		//子优先级3</span><br><span class="line">    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;			//IRQ通道使能</span><br><span class="line">    NVIC_Init(&amp;NVIC_InitStructure);	//根据指定的参数初始化VIC寄存器</span><br><span class="line"></span><br><span class="line">    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);</span><br><span class="line">    </span><br><span class="line">	</span><br><span class="line">	//DMA1通道6 NVIC 配置</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannel = DMA1_Channel6_IRQn;				//NVIC通道设置</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 3 ;				//抢占优先级</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;						//子优先级</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;							//IRQ通道使能</span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);											//根据指定的参数初始化NVIC寄存器</span><br><span class="line"> </span><br><span class="line">	//DMA1通道7 NVIC 配置</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannel = DMA1_Channel7_IRQn;				//NVIC通道设置</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 3 ;				//抢占优先级</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;						//子优先级</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;							//IRQ通道使能</span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);											//根据指定的参数初始化NVIC寄存器</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//USART_GetFlagStatus(USART1,USART_FLAG_RXNE)与USART_GetITStatus(USART1,USART_IT_RXNE)使用起来是一样的</span><br><span class="line">void USART1_IRQHandler(void)                	//串口1中断服务程序</span><br><span class="line">&#123;</span><br><span class="line">	if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)  //接收中断(接收到的数据必须是0x0d 0x0a结尾)</span><br><span class="line">	&#123;</span><br><span class="line">			USART_SendData(USART1,USART_ReceiveData(USART1)); </span><br><span class="line">			USART_ClearITPendingBit(USART1,USART_IT_RXNE);</span><br><span class="line">	 &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/***************************</span><br><span class="line">DMA部分代码</span><br><span class="line">****************************/</span><br><span class="line">void DMA_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">	DMA_InitTypeDef DMA1_Init;</span><br><span class="line">	NVIC_InitTypeDef NVIC_InitStructure;</span><br><span class="line">	DMA_DeInit(DMA1_Channel6);	//将DMA的通道6寄存器重设为缺省值 </span><br><span class="line">	</span><br><span class="line">	//DMA_USART2_RX  USART2-&gt;RAM的数据传输</span><br><span class="line">	DMA1_Init.DMA_PeripheralBaseAddr = (u32)(&amp;USART2-&gt;DR);					//外设地址</span><br><span class="line">	DMA1_Init.DMA_MemoryBaseAddr = (u32)u1rxbuf;            				//内存(接收缓冲区)基地址</span><br><span class="line">	DMA1_Init.DMA_DIR = DMA_DIR_PeripheralSRC;								//数据传输方向，从外设读取到内存</span><br><span class="line">	DMA1_Init.DMA_BufferSize = USART2_MAX_RX_LEN;							//DMA通道的DMA缓存的大小</span><br><span class="line">	DMA1_Init.DMA_PeripheralInc = DMA_PeripheralInc_Disable;				//外设地址寄存器不变（不递增)</span><br><span class="line">	DMA1_Init.DMA_MemoryInc = DMA_MemoryInc_Enable;							//内存地址寄存器递增</span><br><span class="line">	DMA1_Init.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Byte;			//外设数据宽度为8位</span><br><span class="line">	DMA1_Init.DMA_MemoryDataSize = DMA_MemoryDataSize_Byte;					//内存数据宽度为8位</span><br><span class="line">	DMA1_Init.DMA_Mode = DMA_Mode_Normal;									//工作在正常缓存模式</span><br><span class="line">	DMA1_Init.DMA_Priority = DMA_Priority_High; 							//DMA通道x拥有最高优先级 </span><br><span class="line">	DMA1_Init.DMA_M2M = DMA_M2M_Disable;									//DMA通道x没有设置为内存到内存传输</span><br><span class="line">	 </span><br><span class="line">	DMA_Init(DMA1_Channel6,&amp;DMA1_Init); 									//对DMA通道6进行初始化</span><br><span class="line">	</span><br><span class="line">	//DMA_USART2_TX  RAM-&gt;USART2的数据传输</span><br><span class="line">	DMA_DeInit(DMA1_Channel7);												//将DMA的通道7寄存器重设为缺省外设地址启动传输前装入实际RAM地址</span><br><span class="line">	DMA1_Init.DMA_MemoryBaseAddr = (u32)USART2_TX_BUF;              		//内存(发送缓冲区)基地址</span><br><span class="line">	DMA1_Init.DMA_DIR = DMA_DIR_PeripheralDST; 								//数据传输方向，从内存发送到外设</span><br><span class="line">	DMA1_Init.DMA_BufferSize = USART2_MAX_TX_LEN;							//DMA通道的DMA缓存的大小</span><br><span class="line">	DMA1_Init.DMA_PeripheralInc = DMA_PeripheralInc_Disable;				//外设地址寄存器不变</span><br><span class="line">	DMA1_Init.DMA_MemoryInc = DMA_MemoryInc_Enable;							//内存地址寄存器递增</span><br><span class="line">	DMA1_Init.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Byte;			//数据宽度为8位</span><br><span class="line">	DMA1_Init.DMA_MemoryDataSize = DMA_MemoryDataSize_Byte;					//数据宽度为8位</span><br><span class="line">	DMA1_Init.DMA_Mode = DMA_Mode_Normal;									//工作在正常模式</span><br><span class="line">	DMA1_Init.DMA_Priority = DMA_Priority_High; 							//DMA通道x拥有高优先级 </span><br><span class="line">	DMA1_Init.DMA_M2M = DMA_M2M_Disable;									//DMA通道x没有设置为内存到内存传输</span><br><span class="line"></span><br><span class="line">	DMA_Init(DMA1_Channel7,&amp;DMA1_Init); 									//对DMA通道7进行初始化</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	DMA_ITConfig(DMA1_Channel6,DMA_IT_TC,ENABLE);							//开USART2 Rx DMA中断</span><br><span class="line">	DMA_ITConfig(DMA1_Channel7,DMA_IT_TC,ENABLE);							//开USART2 Tx DMA中断</span><br><span class="line"></span><br><span class="line">	DMA_Cmd(DMA1_Channel6,DISABLE);           								//使DMA通道6停止工作</span><br><span class="line">	DMA_Cmd(DMA1_Channel7,DISABLE);           								//使DMA通道7停止工作</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//DMA 发送应用源码</span><br><span class="line">void DMA_USART2_Tx_Data(u8 *buffer, u32 size)</span><br><span class="line">&#123;</span><br><span class="line">	while(USART2_TX_FLAG)&#123;&#125;;						//等待上一次发送完成（USART2_TX_FLAG为1即还在发送数据）,实际应用中，传输数据期间，可以执行另外的任务</span><br><span class="line">	USART2_TX_FLAG=1;							//USART2发送标志（启动发送）</span><br><span class="line">	DMA1_Channel7-&gt;CMAR  = (uint32_t)buffer;	//设置要发送的数据地址,记住需要先失能DMA通道，显然能走到这里通道已经失能</span><br><span class="line">	DMA1_Channel7-&gt;CNDTR = size;    			//设置要发送的字节数目</span><br><span class="line">	DMA_Cmd(DMA1_Channel7, ENABLE);				//开始DMA发送</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//DMA1通道7中断</span><br><span class="line">void DMA1_Channel7_IRQHandler(void)</span><br><span class="line">&#123;</span><br><span class="line">	if(DMA_GetITStatus(DMA1_IT_TC7)!= RESET)	//DMA接收完成标志</span><br><span class="line">	&#123;</span><br><span class="line">		DMA_ClearITPendingBit(DMA1_IT_TC7); 	//清除中断标志 </span><br><span class="line">		USART_ClearFlag(USART2,USART_FLAG_TC);	//清除串口2的标志位</span><br><span class="line">		DMA_Cmd(DMA1_Channel7, DISABLE );   	//关闭USART2 TX DMA1 所指示的通道</span><br><span class="line">		USART2_TX_FLAG=0;						//USART2发送标志(关闭)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//DMA一般接收有两个缓冲区，</span><br><span class="line">//接收定长数据使用传输完成中断，接收</span><br><span class="line">//处理DMA1 通道6的接收完成中断</span><br><span class="line">//定长数据</span><br><span class="line">void DMA1_Channel6_IRQHandler(void)</span><br><span class="line">&#123;</span><br><span class="line">	u8 *p;</span><br><span class="line">	if(DMA_GetITStatus(DMA1_IT_TC6)!= RESET)		//DMA接收完成标志</span><br><span class="line">	&#123;</span><br><span class="line">		DMA_ClearITPendingBit(DMA1_IT_TC6); 		//清除中断标志 </span><br><span class="line">		USART_ClearFlag(USART2,USART_FLAG_TC);		//清除USART2标志位</span><br><span class="line">		DMA_Cmd(DMA1_Channel6, DISABLE );   		//关闭USART2 TX DMA1 所指示的通道；</span><br><span class="line">		</span><br><span class="line">		//接收不定长数据需要增加:</span><br><span class="line">		//USART2_RX_LEN = USART2_MAX_RX_LEN - DMA1_Channel6-&gt;CNDTR;	//获得接收到的字节数</span><br><span class="line">		</span><br><span class="line">		if(witchbuf)                        		//之前用的u2rxbuf，切换为u1rxbuf</span><br><span class="line">		&#123;</span><br><span class="line">			p=u2rxbuf;								//先保存前一次数据地址再切换缓冲区</span><br><span class="line">			DMA1_Channel6-&gt;CMAR=(u32)u1rxbuf;		//切换为u1rxbuf缓冲区地址</span><br><span class="line">			witchbuf=0;                     		//下一次切换为u2rxbuf</span><br><span class="line">		&#125;else                               		//之前用的u1rxbuf，切换为u2rxbuf</span><br><span class="line">		&#123;</span><br><span class="line">			p=u1rxbuf;								//先保存前一次数据地址再切换缓冲区</span><br><span class="line">			DMA1_Channel6-&gt;CMAR=(u32)u2rxbuf;		//切换为u2rxbuf缓冲区地址</span><br><span class="line">			witchbuf=1;                     		//下一次切换为u1rxbuf</span><br><span class="line">		&#125;</span><br><span class="line">		DMA1_Channel6-&gt;CNDTR = USART2_MAX_RX_LEN;	//DMA通道的DMA缓存的大小</span><br><span class="line">		DMA_Cmd(DMA1_Channel6, ENABLE);     		//使能USART2 TX DMA1 所指示的通道</span><br><span class="line">		</span><br><span class="line">		//******************↓↓↓↓↓这里作数据处理↓↓↓↓↓******************//</span><br><span class="line">		</span><br><span class="line">		DMA_USART2_Tx_Data(p,USART2_MAX_RX_LEN);</span><br><span class="line">		、、</span><br><span class="line">		//******************↑↑↑↑↑这里作数据处理↑↑↑↑↑******************//</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//不定长数据</span><br><span class="line"></span><br><span class="line">//串口2中断函数</span><br><span class="line">void USART2_IRQHandler(void)                	</span><br><span class="line">&#123;</span><br><span class="line">	u8 *p;</span><br><span class="line">	//增加</span><br><span class="line">	u8 USART2_RX_LEN = 0;											//接收数据长度</span><br><span class="line">	</span><br><span class="line">	if(USART_GetITStatus(USART2, USART_IT_IDLE) != RESET)			//串口2空闲中断</span><br><span class="line">	&#123;</span><br><span class="line">		//增加</span><br><span class="line">		USART_ReceiveData(USART2); 									//清除串口2空闲中断IDLE标志位</span><br><span class="line">		</span><br><span class="line">		USART_ClearFlag(USART2,USART_FLAG_TC);						//清除USART2标志位</span><br><span class="line">		DMA_Cmd(DMA1_Channel6, DISABLE );   						//关闭USART2 TX DMA1 所指示的通道</span><br><span class="line">		//修改</span><br><span class="line">		USART2_RX_LEN = USART2_MAX_RX_LEN - DMA1_Channel6-&gt;CNDTR;	//获得接收到的字节数</span><br><span class="line">		if(witchbuf)                        						//之前用的u2rxbuf，切换为u1rxbuf</span><br><span class="line">		&#123;</span><br><span class="line">			p=u2rxbuf;												//先保存前一次数据地址再切换缓冲区</span><br><span class="line">			DMA1_Channel6-&gt;CMAR=(u32)u1rxbuf;						//切换为u1rxbuf缓冲区地址</span><br><span class="line">			witchbuf=0;                     						//下一次切换为u2rxbuf</span><br><span class="line">		&#125;else                               						//之前用的u1rxbuf，切换为u2rxbuf</span><br><span class="line">		&#123;</span><br><span class="line">			p=u1rxbuf;												//先保存前一次数据地址再切换缓冲区</span><br><span class="line">			DMA1_Channel6-&gt;CMAR=(u32)u2rxbuf;						//切换为u2rxbuf缓冲区地址</span><br><span class="line">			witchbuf=1;                     						//下一次切换为u1rxbuf</span><br><span class="line">		&#125;</span><br><span class="line">		DMA1_Channel6-&gt;CNDTR = USART2_MAX_RX_LEN;					//DMA通道的DMA缓存的大小</span><br><span class="line">		DMA_Cmd(DMA1_Channel6, ENABLE);     						//使能USART2 TX DMA1 所指示的通道</span><br><span class="line">		</span><br><span class="line">		//******************↓↓↓↓↓这里作数据处理↓↓↓↓↓******************//</span><br><span class="line">		</span><br><span class="line">		//修改：</span><br><span class="line">		DMA_USART2_Tx_Data(p,USART2_RX_LEN);</span><br><span class="line">		</span><br><span class="line">		//******************↑↑↑↑↑这里作数据处理↑↑↑↑↑******************//</span><br><span class="line">		</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="stm32中断">STM32中断</h1>
<p>STM32有68个可屏蔽中断通道，包括EXTI、TIM、ADC等等。使用<strong>NVIC</strong>统一管理中断。STM32的中断优先级可以分为抢占优先级和响应优先级。</p>
<blockquote>
<p>抢占优先级是优先级高的可以在其他中断执行过程中夺得MCU使用权的，响应优先级则是在多个中断同时触发时，获得MCU使用权的优先级。STM32总共有4位数据进行设置抢占和响应优先级，这4位可以进行切分，分为高n位的抢占优先级，和低4-n位的响应优先级。</p>
</blockquote>
<p>中断：要进入NVIC,有相应的中断服务函数，需要CPU处理
事件：不需要进入NVIC，仅用于内部硬件自动控制的，如：TMI,DMA,ADC</p>
<h2 id="exti外部中断">EXTI外部中断</h2>
<p>EXTI可以监测指定的GPIO口的电平信号，在其电平变化时，向NVIC申请中断。
支持的触发方式有：上升沿触发，下降沿触发，双边沿触发，软件触发</p>
<h3 id="使用步骤">使用步骤</h3>
<blockquote>
<p>在STM32中GPIO外部中断信号的流程图如下：
信号----&gt;GPIO---&gt;AFIO(F1) / SYSCFG(F4/F7/H7)
---&gt;EXTI---&gt;NVIC---&gt;CPU</p>
</blockquote>
<h4 id="step1使能gpio时钟">Step1：使能GPIO时钟</h4>
<blockquote>
<p>在STM32中，为了低功耗，几乎所有的外设时钟默认情况下都是关闭的，所以使用外部中断，需要先打开所使用到的GPIO口对应的时钟。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;__HAL_RCC_GPIOx_CLK_ENABLE();</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="step2设置gpioafiosyscfgexti">Step2：设置GPIO/AFIO(SYSCFG)/EXTI</h4>
<blockquote>
<p>EXTI(External interrupt/event
Controller)外部中断事件控制器，包含多条产生事件/中断请求的边沿检测器，即多条EXTI线。每条EXTI线可以单独配置：类型（中断、事件），触发方式（上升沿，下降沿），支持软件触发、开启/屏蔽、挂起</p>
<p>比如EXTI线0-15对应于GPIO0-15，EXTI16对应PVD输出，等等。</p>
<p>所谓的对应关系，IO中断是使用EXTI0-15。EXTI0对应于GPIO
PIN0,而PA0~PG0共用这一根线，那么要将EXTI0与哪个对应？这就是在配置EXTI和IO的对应关系，从这里可以知道，同一编号的IO中断不可以同时使用。</p>
<p><strong>使用IO中断需要配置AFIO(F1)(Alternate Function
IO)复用IO</strong>，如果是F4/F7/H7，则配置SYSCFG，它们功能相似。
AFIO可以用来调试IO配置(SWD/JTAG)，重映射配置，外部中断配置。
<strong>在使用AFIO前一定要打开它的时钟</strong>，RCC_APB2ENR寄存器的的AFIO时钟</p>
<p>关于EXTI屏蔽，上/下沿触发等：</p>
<figure>
<img src="assets/STM32学习.assets/EXTI工作原理图.png" alt="EXTI工作原理图">
<figcaption aria-hidden="true">EXTI工作原理图</figcaption>
</figure>
<p>这是EXTI的工作原理图。
当输入线传来信号时，会先经过边沿检测电路，上升/下降沿触发选择寄存器会控制电路的检测情况，当满足要求，高电平会经过或门（如果打开了软件中断，那么软件中断也可以通过这个，传递中断信号），经过后，会将请求挂起寄存器置1，如果中断屏蔽寄存器是开放中断的（为1），那经与门，就可以得到高电平，将信号送到NVIC。
如果事件屏蔽寄存器是开发中断信号的（为1），那么就可以通过脉冲发生器控制一些硬件的中断。</p>
</blockquote>
<h5 id="step2如果用hal库hal_gpio_init函数一步到位">Step2：如果用HAL库，HAL_GPIO_Init函数一步到位</h5>
<blockquote>
<p>HAL_GPIO_Init() 库函数已经包括了Step2.1-2.4全部内容</p>
</blockquote>
<h5 id="step2.1设置gpio输入模式">Step2.1：设置GPIO输入模式</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="step2.2设置afiosyscfg时钟">Step2.2：设置AFIO/SYSCFG时钟</h5>
<blockquote>
<p>设置代码：</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__HAL_RCC_AFIO_CLK_ENABLE();使能AFIO时钟</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="step2.3设置exti和io对应关系">Step2.3：设置EXTI和IO对应关系。</h5>
<h5 id="step2.4-设置exti屏蔽上下沿触发">Step2.4
设置EXTI屏蔽，上/下沿触发</h5>
<h4 id="step3设置nvic">Step3：设置NVIC</h4>
<h5 id="nvic">NVIC</h5>
<blockquote>
<p>NVIC(Nested vectored interrupt
controller)嵌套向量中断控制器，总共可以支持256个中断，256个优先级，允许裁剪。所以STM32的不同系列的中断数目，优先级不同。</p>
<p>NVIC负责统一管理中断，进行中断的使能，和优先级控制。
许多中断信号发往CPU，如果由CPU负责按优先级处理开启的中断，过于浪费CPU资源且麻烦，于是通过NVIC统一管理，给部分中断使能，并按照优先级的顺序将中断信号发送到CPU，CPU就只要处理中断即可。</p>
<p>中断信号在NVIC的处理流程：</p>
<p>应用程序中断及复位控制寄存器AIRCR寄存器负责管理响应优先级与与抢占优先级的位数切分。</p>
<blockquote>
<p>内核中断信号经SHPR控制，发往CPU
外部中断信号----&gt;ISER/ICER中断使/除能寄存器----&gt;IPR中断优先寄存器寄存器---&gt;CPU</p>
</blockquote>
</blockquote>
<h5 id="step3.1-设置中断分组aircr">Step3.1 设置中断分组AIRCR</h5>
<blockquote>
<p>应用程序中断及复位控制寄存器AIRCR寄存器负责管理响应优先级与与抢占优先级的位数切分。</p>
<p>在STM32中只使用了IPR的4位用来设置优先级，优先级有抢占与响应两种，4位中前几位是抢占优先级，后几位是响应优先级，由AIRCR控制</p>
<p>比如AIRCR中控制优先级的几位是111，则表示0位抢占，4位响应，在STM32中，在STM32中总共有5种分组方式：0-4，...,4-0。</p>
<p>IPR寄存器则是用于配置优先级的大小</p>
<p>设置代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设置中断分组AIRCR：HAL_NVIC_SetPriorityGrouping()</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="step3.2-设置中段优先级">Step3.2 设置中段优先级</h5>
<blockquote>
<p>相关知识在 step3.1 设置中断分组AIRCR 设置代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设置中断优先级IPRx:HAL_NVIC_SetPriority()</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="step3.3-使能中断">Step3.3 使能中断</h5>
<blockquote>
<p>设置代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使能中断ISERx:HAL_NVIC_EnableIRQ</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="step4设计中断服务函数">Step4：设计中断服务函数</h4>
<blockquote>
<p>首先我们编写的中断服务函数（硬件）时，应该与官方文件中规定的中断服务函数名比如EXTIx_IRQHandler()一致。
HAL库：</p>
<ul>
<li><p>EXTIx_IRQHandler()的代码只是调用了HAL_GPIO_EXTI_IRQHandler()函数;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EXTI15_10_IRQHandler</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	HAL_GPIO_EXTI_IRQHandler(GPIO_PIN_10);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>HAL_GPIO_EXTI_IRQHandler函数会先判断该GPIO口的是否发生中断（中断标志位是否为1），如果是，清除中断，并调用回调函数HAL_GPIO_EXTI_Callback()函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//官方文档中的</span><br><span class="line">void HAL_GPIO_EXTI_IRQHandler(uint16_t GPIO_Pin)&#123;</span><br><span class="line">	if(__HAL_GPIO_EXTI_GET_IT(GPIO_Pin)!=RESET)&#123;</span><br><span class="line">		__HAL_GPIO_EXTI_CLEAT_IT(GPIO_Pin);</span><br><span class="line">		HAL_GPIO_EXTI_Callback(GPIO_Pin);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>HAL_GPIO_EXTI_Callback(uint16_t
GPIO_Pin)这个函数是真正执行具体功能的函数，该函数需要用户重写。</p></li>
<li><p><strong>总结</strong></p>
<ul>
<li><p>使用HAL库需要按照上述格式写中断服务函数如：EXTIx_IRQHandler()</p>
<p>然后写执行中断具体功能的函数HAL_GPIO_EXTI_Callback(uint16_t
GPIO_Pin)</p>
<p>可以不清除标志位</p></li>
<li><p>也可以仿照上述流程自己写EXTIx_IRQHandler()，功能，清标志等都写在里面，不调用回调函数</p></li>
</ul></li>
</ul>
</blockquote>
<h3 id="外部中断点灯示例">外部中断点灯示例</h3>
<p>按键key0：一端接地，一端接PC5。故PC5使用上拉输入模式，按键松开，读到高电平，按下，读到低电平。
小灯LED0：正极接电源，负极接PA8。故PA8采用推挽输出，输出低电平，小灯亮。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment">点灯代码</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f1xx_hal.h&quot;</span>   </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED0_Pin GPIO_PIN_8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED0_GPIO_Port GPIOA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_Pin GPIO_PIN_5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_GPIO_Port GPIOC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_EXTI_IRQn EXTI9_5_IRQn</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_Press GPIO_PIN_RESET</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0_NotPress GPIO_PIN_SET</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED0_ON() HAL_GPIO_WritePin(LED0_GPIO_Port, LED0_Pin,GPIO_PIN_RESET)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED0_OFF() HAL_GPIO_WritePin(LED0_GPIO_Port, LED0_Pin, GPIO_PIN_SET)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED0_Toggle() HAL_GPIO_TogglePin(LED0_GPIO_Port, LED0_Pin)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exti_init</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">SystemClock_Config</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123; </span><br><span class="line">	HAL_Init();<span class="comment">//初始化HAL库    </span></span><br><span class="line">	SystemClock_Config();  	<span class="comment">//设置时钟,72M</span></span><br><span class="line">	exti_init();</span><br><span class="line">	LED0_OFF();</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment">中断代码</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exti_init</span><span class="params">()</span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStruct=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//开启开关和按键的时钟</span></span><br><span class="line">	__HAL_RCC_GPIOC_CLK_ENABLE();</span><br><span class="line">	__HAL_RCC_GPIOA_CLK_ENABLE();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//配置GPIO输入模式，AFIO时钟，EXTI</span></span><br><span class="line">	GPIO_InitStruct.Pin=LED0_Pin;</span><br><span class="line">	GPIO_InitStruct.Mode=GPIO_MODE_OUTPUT_PP;</span><br><span class="line">	GPIO_InitStruct.Pull=GPIO_NOPULL;</span><br><span class="line">	GPIO_InitStruct.Speed=GPIO_SPEED_FREQ_HIGH;</span><br><span class="line">	HAL_GPIO_Init(LED0_GPIO_Port,&amp;GPIO_InitStruct);</span><br><span class="line">	</span><br><span class="line">	GPIO_InitStruct.Pin=KEY0_Pin;</span><br><span class="line">	GPIO_InitStruct.Mode=GPIO_MODE_IT_FALLING;<span class="comment">//采用外部中断，下降沿触发</span></span><br><span class="line">	GPIO_InitStruct.Pull=GPIO_PULLUP;</span><br><span class="line">	HAL_GPIO_Init(KEY0_GPIO_Port,&amp;GPIO_InitStruct);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//设置NVIC</span></span><br><span class="line">	HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_2);</span><br><span class="line">	HAL_NVIC_SetPriority(EXTI9_5_IRQn,<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">	HAL_NVIC_EnableIRQ(EXTI9_5_IRQn);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中断服务函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">EXTI9_5_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    HAL_GPIO_EXTI_IRQHandler(KEY0_Pin );		<span class="comment">//调用中断处理公用函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写回调函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//		HAL_Delay(100);</span></span><br><span class="line">    <span class="keyword">if</span>(GPIO_Pin==KEY0_Pin)&#123;</span><br><span class="line">			<span class="keyword">if</span>(HAL_GPIO_ReadPin(KEY0_GPIO_Port, KEY0_Pin)==KEY0_Press)&#123;</span><br><span class="line">				LED0_Toggle();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//系统时钟时钟</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SystemClock_Config</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	HAL_StatusTypeDef ret = HAL_OK;</span><br><span class="line">	RCC_OscInitTypeDef RCC_OscInitStructure; </span><br><span class="line">	RCC_ClkInitTypeDef RCC_ClkInitStructure;</span><br><span class="line"></span><br><span class="line">	RCC_OscInitStructure.OscillatorType=RCC_OSCILLATORTYPE_HSE;    	<span class="comment">//时钟源为HSE</span></span><br><span class="line">	RCC_OscInitStructure.HSEState=RCC_HSE_ON;                      	<span class="comment">//打开HSE</span></span><br><span class="line">	RCC_OscInitStructure.HSEPredivValue=RCC_HSE_PREDIV_DIV1;		<span class="comment">//HSE预分频</span></span><br><span class="line">	RCC_OscInitStructure.PLL.PLLState=RCC_PLL_ON;					<span class="comment">//打开PLL</span></span><br><span class="line">	RCC_OscInitStructure.PLL.PLLSource=RCC_PLLSOURCE_HSE;			<span class="comment">//PLL时钟源选择HSE</span></span><br><span class="line">	RCC_OscInitStructure.PLL.PLLMUL=RCC_PLL_MUL9; 							<span class="comment">//主PLL倍频因子</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(HAL_RCC_OscConfig(&amp;RCC_OscInitStructure)!=HAL_OK) &#123;</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//选中PLL作为系统时钟源并且配置HCLK,PCLK1和PCLK2</span></span><br><span class="line">	RCC_ClkInitStructure.ClockType=(RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2);</span><br><span class="line">	RCC_ClkInitStructure.SYSCLKSource=RCC_SYSCLKSOURCE_PLLCLK;		<span class="comment">//设置系统时钟时钟源为PLL</span></span><br><span class="line">	RCC_ClkInitStructure.AHBCLKDivider=RCC_SYSCLK_DIV1;				<span class="comment">//AHB分频系数为1</span></span><br><span class="line">	RCC_ClkInitStructure.APB1CLKDivider=RCC_HCLK_DIV2; 				<span class="comment">//APB1分频系数为2</span></span><br><span class="line">	RCC_ClkInitStructure.APB2CLKDivider=RCC_HCLK_DIV1; 				<span class="comment">//APB2分频系数为1</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStructure,FLASH_LATENCY_2) != HAL_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="iwdg">IWDG</h1>
<ul>
<li>IWDG(Independent
watchdog)本质上是一个可以产生系统<strong>复位</strong>信号的计数器，主要用于解决CPU异常，程序故障等问题。</li>
<li>IWDG是一个递减的计数器，由独立的RC振荡器(LSI)提供时钟（可在待机/停止模式下运行），看门狗被激活后，计数器不断递减，直到计数为0x000时，产生复位。如果在此期间，喂狗（重装载计数器的值），就会重新开始计数，不会复位。</li>
<li>看门狗的使用RC振荡器，时钟不够精确，一般用于要求高稳定，对时间精确要求不严的场合。</li>
</ul>
<p>​</p>
<h2 id="iwdg的工作原理">IWDG的工作原理</h2>
<figure>
<img src="assets/STM32学习.assets/IWDG工作原理简图.png" alt="IWDG工作原理简图">
<figcaption aria-hidden="true">IWDG工作原理简图</figcaption>
</figure>
<figure>
<img src="assets/STM32学习.assets/IWDG框图.png" alt="IWDG框图">
<figcaption aria-hidden="true">IWDG框图</figcaption>
</figure>
<ul>
<li><strong>预分频寄存器：</strong>用于设置预分频系数</li>
<li><strong>状态寄存器</strong>：显示看门狗的状态，比如预分频值是否更新结束，重装载值是否更新结束。比如只有预分频值更新结束后，才可以修改重装载寄存器，读取的重装载值才有效。</li>
<li><strong>重装载寄存器</strong>：用于重载递减计数器的值，<strong>最大为4096</strong>。当收到键寄存器的喂狗指令会喂狗。</li>
<li><strong>键寄存器：</strong>用于启动看门狗，喂狗，使能IWDG_PR,IWDG_RLR的访问许可。写入0xAAAA可以让重装载寄存器喂狗，写入0x5555是使能访问许可，写入0xCCCC是启动看门狗。</li>
</ul>
<p>LSI提供的时钟信号经过预分频器分频，得到看门狗时钟频率IWDG
CLK，给递减计数器提供时钟，当递减计数器计数到0，就会进行复位。
同时当预分频寄存器，重装载寄存器正在更新中与更新结束时，都会通知状态寄存器，改变其值。</p>
<h2 id="iwdg预分频器的溢出时间计算">IWDG预分频器的溢出时间计算</h2>
<p>LSI的时钟频率不精确，F1系列在30KHZ到60KHZ之间变化，通常我们取40KHZ的典型值，当然具体的还是请参考数据手册。</p>
<p><span class="math display">\[
\begin{aligned}
&amp;溢出时间计算公式：T_{out}=\frac{psc*rlr}{f_{IWDG}} \\
&amp;T_{out}是溢出时间、f_{IWDG}是是时钟源频率、psc是预分频系数，rlr是看门狗的重装载值。
\end{aligned}
\]</span></p>
<p>关于预分频系数如何选择，不同的预分频系数对应的最短溢出时间（计数1次）和最长溢出时间不同（计数4096次）不同，我们应根据需要的溢出时间选择合适的。参考手册里有对应表格，可以自己算，也可查表。</p>
<h2 id="看门狗的配置">看门狗的配置</h2>
<h3 id="寄存器配置">寄存器配置</h3>
<p>这是看门狗的寄存器配置步骤，具体的建议参考相关参考手册。</p>
<figure>
<img src="assets/STM32学习.assets/独立看门狗的寄存器配置操作步骤.png" alt="独立看门狗的寄存器配置操作步骤">
<figcaption aria-hidden="true">独立看门狗的寄存器配置操作步骤</figcaption>
</figure>
<h3 id="hal库配置">HAL库配置</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">这两个函数定义于文件如stm32f1xx_hal_iwdg.c中,对应的.h文件有参数的定义及参考值。</span><br><span class="line">HAL_IWDG_Init(IWDG_HandleTypeDef *hiwdg)：使能IWDG,取消PR/RLR寄存器写保护，设置预分频系数和重装载值，</span><br><span class="line">HAL_IWDG_Refresh(IWDG_HandleTypeDef *hiwdg)：喂狗，即写入<span class="number">0xAAAA</span>到IWDG_KR</span><br><span class="line"></span><br><span class="line">.h文件：</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">//IWDG的寄存器的基地址,可以在stm32f103xe.h中找到  #define IWDG    ((IWDG_TypeDef *)IWDG_BASE)   IWDG_TypeDef是IWDG的寄存器结构体</span></span><br><span class="line">  IWDG_TypeDef *Instance;   </span><br><span class="line">  <span class="comment">//IWDG初始值</span></span><br><span class="line">  IWDG_InitTypeDef Init;      </span><br><span class="line">&#125; IWDG_HandleTypeDef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint32_t</span> Prescaler; <span class="comment">//分频系数</span></span><br><span class="line">  <span class="type">uint32_t</span> Reload;  <span class="comment">//重装载值</span></span><br><span class="line">&#125; IWDG_InitTypeDef;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;delay.h&quot;</span><br><span class="line"></span><br><span class="line">#include &quot;stm32f1xx_hal.h&quot;   </span><br><span class="line">#include&quot;stdio.h&quot;</span><br><span class="line"></span><br><span class="line">//串口配置句柄，发送缓冲区和接收缓冲区</span><br><span class="line">UART_HandleTypeDef huart1;</span><br><span class="line">uint8_t TxBuf[]=&quot;Hello World&quot;;</span><br><span class="line">uint8_t RxBuf[4];</span><br><span class="line"></span><br><span class="line">//重定向printf函数</span><br><span class="line">#if 1</span><br><span class="line">#pragma import(__use_no_semihosting)             </span><br><span class="line">//标准库需要的支持函数                 </span><br><span class="line">struct __FILE </span><br><span class="line">&#123; </span><br><span class="line">	int handle; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">FILE __stdout;       </span><br><span class="line">//定义_sys_exit()以避免使用半主机模式    </span><br><span class="line">void _sys_exit(int x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line">//重定义fputc函数 </span><br><span class="line">int fputc(int ch, FILE *f)</span><br><span class="line">&#123;      </span><br><span class="line">	while((USART1-&gt;SR&amp;0X40)==0);//循环发送,直到发送完毕   </span><br><span class="line">    USART1-&gt;DR = (unsigned char) ch;      </span><br><span class="line">	return ch;</span><br><span class="line">&#125;</span><br><span class="line">#endif </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//声明函数</span><br><span class="line">void SystemClock_Config(void);</span><br><span class="line">static void MX_USART1_UART_Init(void);</span><br><span class="line">void IWDG_Init(void);</span><br><span class="line">void IWDG_Feed(void);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">在代码中将看门狗配置为每秒必须喂狗一次，否则会复位。加上串口部分内容。</span><br><span class="line">运行的效果是：</span><br><span class="line">当延时时间delay_ms(1009)大于1s,不能及时喂狗：在打印完&quot;您还没喂狗，请及时喂狗&quot;后，延时函数执行时，时间达到一秒，复位，反复执行上述流程。</span><br><span class="line">当延时时间delay_ms()小于1s,可以及时喂狗：在打印完&quot;您还没喂狗，请及时喂狗&quot;后，延时函数执行后，喂狗，&quot;已经喂狗&quot;，不断重复while循环中的内容。</span><br><span class="line">由于LSI不精确，可能delay_ms(1009)延时，仍然可以成功喂狗。</span><br><span class="line">**********************************************************************/</span><br><span class="line">int main(void)</span><br><span class="line">&#123; </span><br><span class="line">	//我们要使用HAL库，所以一定要先初始化HAL库，要使用STM32，需要先初始化系统时钟</span><br><span class="line">	HAL_Init();//初始化HAL库    </span><br><span class="line">	SystemClock_Config();  	//设置时钟,72M,</span><br><span class="line">	delay_init(72);//初始化延时函数</span><br><span class="line">	//出于对代码调试的需要，加上了串口</span><br><span class="line">	MX_USART1_UART_Init();</span><br><span class="line">	printf(&quot;您还没喂狗，请及时喂狗&quot;);</span><br><span class="line">	</span><br><span class="line">	IWDG_Init();//初始化看门狗</span><br><span class="line">	while(1)&#123;</span><br><span class="line">		delay_ms(1009);</span><br><span class="line">		IWDG_Feed();//喂狗</span><br><span class="line">		printf(&quot;已经喂狗&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">看门狗代码</span><br><span class="line">**********************************************************************/</span><br><span class="line">IWDG_HandleTypeDef IWDG_Handler; //独立看门狗句柄,定义为全局变量</span><br><span class="line">void IWDG_Init()&#123;</span><br><span class="line">	IWDG_Handler.Instance=IWDG;</span><br><span class="line">	//由于希望每秒喂一次狗，所以选择分频系数32,对应的重装载值为1250   1s=1250*32/40000，参考溢出时间计算公式。</span><br><span class="line">	IWDG_Handler.Init.Prescaler=IWDG_PRESCALER_32;</span><br><span class="line">	IWDG_Handler.Init.Reload=1250;</span><br><span class="line">	HAL_IWDG_Init(&amp;IWDG_Handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void IWDG_Feed(void)&#123;</span><br><span class="line">	HAL_IWDG_Refresh(&amp;IWDG_Handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">串口部分代码</span><br><span class="line">**********************************************************************/</span><br><span class="line">static void MX_USART1_UART_Init(void)</span><br><span class="line">&#123;</span><br><span class="line">  huart1.Instance = USART1;							//USART1</span><br><span class="line">  huart1.Init.BaudRate = 115200;					//波特兰</span><br><span class="line">  huart1.Init.WordLength = UART_WORDLENGTH_8B;		//8位数据位</span><br><span class="line">  huart1.Init.StopBits = UART_STOPBITS_1;			//一个停止位</span><br><span class="line">  huart1.Init.Parity = UART_PARITY_NONE;			//无奇偶校验位</span><br><span class="line">  huart1.Init.Mode = UART_MODE_TX_RX;				//收发模式</span><br><span class="line">  huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;		//无硬件流控</span><br><span class="line">  huart1.Init.OverSampling = UART_OVERSAMPLING_16;  //？？？？？</span><br><span class="line">  if (HAL_UART_Init(&amp;huart1) != HAL_OK)				//HAL_UART_Init()会使能UART1</span><br><span class="line">  &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//UART底层初始化，时钟使能，引脚配置，中断配置</span><br><span class="line">//此函数会被HAL_UART_Init()调用</span><br><span class="line">void HAL_UART_MspInit(UART_HandleTypeDef *huart)//huart:串口句柄</span><br><span class="line">&#123;</span><br><span class="line">    //GPIO端口设置</span><br><span class="line">	GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">	</span><br><span class="line">	if(huart-&gt;Instance==USART1)//如果是串口1，进行串口1 MSP初始化</span><br><span class="line">	&#123;</span><br><span class="line">		__HAL_RCC_GPIOA_CLK_ENABLE();			//使能GPIOA时钟</span><br><span class="line">		__HAL_RCC_USART1_CLK_ENABLE();			//使能USART1时钟</span><br><span class="line">		__HAL_RCC_AFIO_CLK_ENABLE();</span><br><span class="line">	</span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_9;			//PA9</span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_PP;		//复用推挽输出</span><br><span class="line">		GPIO_Initure.Pull=GPIO_PULLUP;			//上拉</span><br><span class="line">		GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;//高速</span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);	   	//初始化PA9</span><br><span class="line"></span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_10;			//PA10</span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_INPUT;	//模式要设置为复用输入模式！	</span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);	   	//初始化PA10</span><br><span class="line">		</span><br><span class="line">		HAL_NVIC_EnableIRQ(USART1_IRQn);				//使能USART1中断通道</span><br><span class="line">		HAL_NVIC_SetPriority(USART1_IRQn,3,3);			//抢占优先级3，子优先级3</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">系统时钟代码</span><br><span class="line">**********************************************************************/</span><br><span class="line">//系统时钟</span><br><span class="line">void SystemClock_Config(void)</span><br><span class="line">&#123;</span><br><span class="line">	RCC_OscInitTypeDef RCC_OscInitStructure; </span><br><span class="line">	RCC_ClkInitTypeDef RCC_ClkInitStructure;</span><br><span class="line"></span><br><span class="line">	RCC_OscInitStructure.OscillatorType=RCC_OSCILLATORTYPE_HSE;    	//时钟源为HSE  8MHZ</span><br><span class="line">	RCC_OscInitStructure.HSEState=RCC_HSE_ON;                      	//打开HSE</span><br><span class="line">	RCC_OscInitStructure.HSEPredivValue=RCC_HSE_PREDIV_DIV1;		//HSE预分频 8/1=8MHZ</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLState=RCC_PLL_ON;					//打开PLL</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLSource=RCC_PLLSOURCE_HSE;			//PLL时钟源选择HSE</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLMUL=RCC_PLL_MUL9; 							//主PLL倍频因子	8*9=72MHZ</span><br><span class="line"></span><br><span class="line">	if(HAL_RCC_OscConfig(&amp;RCC_OscInitStructure)!=HAL_OK) &#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//选中PLL作为系统时钟源并且配置HCLK,PCLK1和PCLK2</span><br><span class="line">	RCC_ClkInitStructure.ClockType=(RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2);</span><br><span class="line">	RCC_ClkInitStructure.SYSCLKSource=RCC_SYSCLKSOURCE_PLLCLK;		//设置系统时钟时钟源为PLL</span><br><span class="line">	RCC_ClkInitStructure.AHBCLKDivider=RCC_SYSCLK_DIV1;				//AHB分频系数为1	 72MHZ</span><br><span class="line">	RCC_ClkInitStructure.APB1CLKDivider=RCC_HCLK_DIV2; 				//APB1分频系数为2	PCLK1 窗口看门狗时钟就来自于它 72/2=36MHZ</span><br><span class="line">	RCC_ClkInitStructure.APB2CLKDivider=RCC_HCLK_DIV1; 				//APB2分频系数为1	PCLK2 72/1=72MHZ</span><br><span class="line">	</span><br><span class="line">	if (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStructure,FLASH_LATENCY_2) != HAL_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="wwdg">WWDG</h1>
<ul>
<li>WWDG(Window
watchdog)窗口看门狗：能够<strong>产生系统复位</strong>信号和<strong>提前唤醒中断</strong>的计数器。通常被用来检测软件故障，运行时效是否精准，常用于需要精确监测程序运行时间的场合。</li>
<li>复位的情况：
<ul>
<li>计数器从设定的重载值递减至设定的窗口值(不包括窗口值）前，不允许喂狗，喂狗会导致复位</li>
<li>在计数器从窗口值（包括）递减至0x3f时，会产生复位。所以可以在这期间喂狗，防止复位，也只有这段时间可以喂狗。</li>
</ul></li>
<li>中断的情况：当计数器达到0x40时，会参数早期唤醒中断（EWI)</li>
<li>综上：避免复位应只在也必须在窗口期(窗口值到0x3f)喂狗，可以通过控制延时，尽早喂狗与中断EWI喂狗两种方式进行</li>
</ul>
<figure>
<img src="assets/STM32学习.assets/WWDG工作原理.png" alt="WWDG工作原理">
<figcaption aria-hidden="true">WWDG工作原理</figcaption>
</figure>
<h2 id="wwdg工作原理">WWDG工作原理</h2>
<figure>
<img src="assets/STM32学习.assets/窗口看门狗框图.png" alt="窗口看门狗框图">
<figcaption aria-hidden="true">窗口看门狗框图</figcaption>
</figure>
<p>WDGA位为1代表启动看门狗。
在看门狗开启的情况下，如果T6为0(当计数器的值从0x40变到0x3f,T6的值变为0），那么③处的电平为0,经过非门和或门，使得②处电平也为1,开启复位。
在看门狗开启的情况下，计数器从设定的重载值递减至设定的窗口值(不包括窗口值）前，⑥处电平1，如果喂狗(会写入WWDG_CR),⑤电平为1，从而使得④②处电平也为1,开启复位。</p>
<h2 id="超时时间计算">超时时间计算</h2>
<p><span class="math display">\[
\begin{aligned}&amp;超时时间计算公式：T_{WWDG}=\frac{4096*2^{WDGTB}*(T[5:0]+1)}{f_{WWDG}}
\\&amp;T_{WWDG}是超时时间、f_{WWDG}是是时钟源频率、2^{WDGTB}是预分频系数，在预分频器中设置，4096是WWDG的固定的分频系数。\end{aligned}
\]</span></p>
<h2 id="wwdg配置步骤">WWDG配置步骤</h2>
<h3 id="hal库配置-1">HAL库配置</h3>
<p>这里我们给出的是中断EWI喂狗的步骤和方式，延时喂狗请参考窗口看门狗自行修改</p>
<ul>
<li>HAL_WWDG_Init() 工作参数初始化，使能WWDG,设置预分频系数和窗口值</li>
<li>HAL_WWDG_MspInit() WWDG Msp初始化，用于配置NVIC,CLOCK等</li>
<li>HAL_NVIC_SetPriority()、HAL_NVIC_Enable() 设置优先级、使能中断</li>
<li>WWDG_IRQ_Handler()--&gt;HAL_WWDG_IRQ_Handler() 编写中断服务函数</li>
<li>HAL_WWDG_EarlyWakeupCallback() 重定义提前唤醒回调函数</li>
<li>HAL_WWDG_Refresh() 喂狗</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  uint32_t Prescaler; </span><br><span class="line">  uint32_t Window;</span><br><span class="line">  uint32_t Counter</span><br><span class="line">  uint32_t EWIMode ; </span><br><span class="line">&#125; WWDG_InitTypeDef;</span><br><span class="line"></span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  WWDG_TypeDef                 *Instance; </span><br><span class="line">  WWDG_InitTypeDef             Init;   </span><br><span class="line">&#125; WWDG_HandleTypeDef;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;delay.h&quot;</span><br><span class="line"></span><br><span class="line">#include &quot;stm32f1xx_hal.h&quot;   </span><br><span class="line">#include&quot;stdio.h&quot;</span><br><span class="line"></span><br><span class="line">//声明函数</span><br><span class="line">void SystemClock_Config(void);</span><br><span class="line">void WWDG_Init(void);</span><br><span class="line">void LED_Init(void);</span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">运行的效果是：</span><br><span class="line">代码在While中循环，每隔58.25ms看门狗计数到0x40触发中断，调用中断处理函数，翻转小灯电平</span><br><span class="line">**********************************************************************/</span><br><span class="line">int main(void)</span><br><span class="line">&#123; </span><br><span class="line">	//我们要使用HAL库，所以一定要先初始化HAL库，要使用STM32，需要先初始化系统时钟</span><br><span class="line">	HAL_Init();//初始化HAL库    </span><br><span class="line">	SystemClock_Config();  	//设置时钟72M，设置了窗口看门狗时钟为32MHZ</span><br><span class="line">	delay_init(72);</span><br><span class="line">	LED_Init();							//初始化LED	</span><br><span class="line">	WWDG_Init();//初始化看门狗</span><br><span class="line">	while(1)&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">看门狗代码</span><br><span class="line">**********************************************************************/</span><br><span class="line">WWDG_HandleTypeDef WWDG_Handler;     //窗口看门狗句柄,定义为全局变量</span><br><span class="line">void WWDG_Init()&#123;</span><br><span class="line">	//超出时间计算：58.25ms=4096*8*(0x7F-0x3F)/36MHZ*1000</span><br><span class="line">    WWDG_Handler.Instance=WWDG;</span><br><span class="line">    WWDG_Handler.Init.Prescaler=WWDG_PRESCALER_8; 		//设置分频系数</span><br><span class="line">    WWDG_Handler.Init.Window=0x5F;       		//设置窗口值</span><br><span class="line">    WWDG_Handler.Init.Counter=0x7F;     		//设置计数器值</span><br><span class="line">    WWDG_Handler.Init.EWIMode=WWDG_EWI_ENABLE;//使能窗口看门狗提前唤醒中断 </span><br><span class="line">    HAL_WWDG_Init(&amp;WWDG_Handler);        	//初始化WWDG</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//WWDG底层驱动，时钟配置，中断配置</span><br><span class="line">//此函数会被HAL_WWDG_Init()调用</span><br><span class="line">void HAL_WWDG_MspInit(WWDG_HandleTypeDef *hwwdg) //hwwdg:窗口看门狗句柄</span><br><span class="line">&#123;   </span><br><span class="line">    __HAL_RCC_WWDG_CLK_ENABLE();    //使能窗口看门狗时钟</span><br><span class="line">        </span><br><span class="line">    HAL_NVIC_SetPriority(WWDG_IRQn,2,3);    //抢占优先级2，子优先级为3</span><br><span class="line">    HAL_NVIC_EnableIRQ(WWDG_IRQn);          //使能窗口看门狗中断</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//窗口看门狗中断服务函数</span><br><span class="line">void WWDG_IRQHandler(void)</span><br><span class="line">&#123;</span><br><span class="line">    HAL_WWDG_IRQHandler(&amp;WWDG_Handler);//调用WWDG共用中断处理函数</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//中断服务函数处理过程</span><br><span class="line">//此函数会被HAL_WWDG_IRQHandler()调用</span><br><span class="line">void HAL_WWDG_EarlyWakeupCallback(WWDG_HandleTypeDef* hwwdg)</span><br><span class="line">&#123;</span><br><span class="line">    HAL_WWDG_Refresh(&amp;WWDG_Handler);//更新窗口看门狗值</span><br><span class="line">    HAL_GPIO_TogglePin( GPIOA, GPIO_PIN_8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">小灯代码</span><br><span class="line">**********************************************************************/</span><br><span class="line">//LED IO初始化</span><br><span class="line">void LED_Init(void)</span><br><span class="line">&#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">    __HAL_RCC_GPIOA_CLK_ENABLE();           	//开启GPIOA时钟</span><br><span class="line">    </span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_8; 				//PA8</span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_OUTPUT_PP;  	//推挽输出</span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLUP;          	//上拉</span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;    //高速</span><br><span class="line">    HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure);</span><br><span class="line"></span><br><span class="line">    HAL_GPIO_WritePin(GPIOA,GPIO_PIN_8,GPIO_PIN_SET);	//PA8置1，默认初始化后灯灭</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**********************************************************************</span><br><span class="line">系统时钟代码</span><br><span class="line">**********************************************************************/</span><br><span class="line">//系统时钟</span><br><span class="line">void SystemClock_Config(void)</span><br><span class="line">&#123;</span><br><span class="line">	RCC_OscInitTypeDef RCC_OscInitStructure; </span><br><span class="line">	RCC_ClkInitTypeDef RCC_ClkInitStructure;</span><br><span class="line"></span><br><span class="line">	RCC_OscInitStructure.OscillatorType=RCC_OSCILLATORTYPE_HSE;    	//时钟源为HSE  8MHZ</span><br><span class="line">	RCC_OscInitStructure.HSEState=RCC_HSE_ON;                      	//打开HSE</span><br><span class="line">	RCC_OscInitStructure.HSEPredivValue=RCC_HSE_PREDIV_DIV1;		//HSE预分频 8/1=8MHZ</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLState=RCC_PLL_ON;					//打开PLL</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLSource=RCC_PLLSOURCE_HSE;			//PLL时钟源选择HSE</span><br><span class="line">	RCC_OscInitStructure.PLL.PLLMUL=RCC_PLL_MUL9; 							//主PLL倍频因子	8*9=72MHZ</span><br><span class="line"></span><br><span class="line">	if(HAL_RCC_OscConfig(&amp;RCC_OscInitStructure)!=HAL_OK) &#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//选中PLL作为系统时钟源并且配置HCLK,PCLK1和PCLK2</span><br><span class="line">	RCC_ClkInitStructure.ClockType=(RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2);</span><br><span class="line">	RCC_ClkInitStructure.SYSCLKSource=RCC_SYSCLKSOURCE_PLLCLK;		//设置系统时钟时钟源为PLL</span><br><span class="line">	RCC_ClkInitStructure.AHBCLKDivider=RCC_SYSCLK_DIV1;				//AHB分频系数为1	 72MHZ</span><br><span class="line">	RCC_ClkInitStructure.APB1CLKDivider=RCC_HCLK_DIV2; 				//APB1分频系数为2	PCLK1 窗口看门狗时钟就来自于它 72/2=36MHZ</span><br><span class="line">	RCC_ClkInitStructure.APB2CLKDivider=RCC_HCLK_DIV1; 				//APB2分频系数为1	PCLK2 72/1=72MHZ</span><br><span class="line">	</span><br><span class="line">	if (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStructure,FLASH_LATENCY_2) != HAL_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		while(1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="systick">SysTick</h1>
<p>SysTick系统节拍时钟，是ARM
Cortex-M3内核的一个内设，STM32属于该内核，因此有SysTick。
由于所有该内核的都有SysTick,显然，它将使得程序的可移植性更好。</p>
<ul>
<li>工作原理：从其结构图可以明显的看出，首先SysTick从时钟源接口获得时钟驱动，然后从重装寄存器将重装值读入当前计数寄存器，并在时钟驱动下减一计数，发生下溢时，将计数标志置位，并在满足一定条件下触发SysTick溢出中断，同时进行一次重装值载入操作。</li>
</ul>
<figure>
<img src="assets/STM32学习.assets/SysTick定时器基本结构.png" alt="SysTick定时器基本结构">
<figcaption aria-hidden="true">SysTick定时器基本结构</figcaption>
</figure>
<figure>
<img src="assets/STM32学习.assets/SysTick定时器寄存器.png" alt="SysTick定时器寄存器">
<figcaption aria-hidden="true">SysTick定时器寄存器</figcaption>
</figure>
<ul>
<li>步骤
<ul>
<li>配置SysTick的预装载值，时钟源以及分频</li>
<li>写SysTick中断服务函数</li>
</ul></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">u32 tick=0;</span><br><span class="line"></span><br><span class="line">void delay_1s(void)</span><br><span class="line">&#123;</span><br><span class="line">	tick=0;</span><br><span class="line">	while(tick&lt;1000);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">void Systick_Configuration(void)</span><br><span class="line">&#123;</span><br><span class="line">	//主频为72/8=9 MHz,故1ms计时： 1000*计数次数/主频=1ms--&gt;计数次数=主频/1000</span><br><span class="line">	SysTick_Config(9000000/1000);</span><br><span class="line">	//选择HCLK进行8分频后作为Systick时钟源，本函数一定要置于SysTick_Config后调用</span><br><span class="line">	//时钟源在SysTick_Config中会将时钟源位置重新设置，使得设置的时钟无效</span><br><span class="line">	//但是将SysTick_CLKSourceConfig移到SysTick_Config之后调用，要记得先禁能，然后调用SysTick_CLKSourceConfig，再使能。我不会</span><br><span class="line">	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK_Div8);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void Systick_Handler(void)</span><br><span class="line">&#123;</span><br><span class="line">	tick++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">	Systick_Configuration();</span><br><span class="line">	delay_1s();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">/*****************************</span><br><span class="line">显然这里的配置流程可以分为两类，这里的代码是第一类</span><br><span class="line">一类是实现一个延时功能，延时功能只需要定时器工作一个周期，也就是从重装载值减到0的一个过程，执行一次后需要关闭定时器</span><br><span class="line">实现系统的us延时（参数）</span><br><span class="line">&#123;</span><br><span class="line">   //选择时钟 建议选择外部时钟</span><br><span class="line">   //写入重装载值  21*参数</span><br><span class="line">   //当前值清零</span><br><span class="line">   //打开计数器</span><br><span class="line">   //等待标志位置1</span><br><span class="line">   //关闭计数器</span><br><span class="line">&#125;</span><br><span class="line">一类是利用中断，一定时间进一次中断，以此来实现一个时间片轮询的操作方式。这时候，就需要定时器一直计数了</span><br><span class="line"></span><br><span class="line">系统滴答的初始化代码</span><br><span class="line">&#123;</span><br><span class="line">   //选择系统滴答的时钟</span><br><span class="line">   //配置系统抵达的重装载值</span><br><span class="line">   //当前值清零</span><br><span class="line">   //打开中断使能 </span><br><span class="line">   </span><br><span class="line">   //NVIC控制器</span><br><span class="line"></span><br><span class="line">   //开启定时器   </span><br><span class="line">&#125;</span><br><span class="line">中断服务函数</span><br><span class="line">&#123;</span><br><span class="line">	判断标志；</span><br><span class="line">	清楚标志；</span><br><span class="line">	执行操作。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//SysTick设置中断优先级为15： NVIC_SetPriority (SysTick_IRQn, (1&lt;&lt;__NVIC_PRIO_BITS) - 1);</span><br><span class="line">******************************/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">u8 reload=0;</span><br><span class="line">void delay_init()&#123;</span><br><span class="line">	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK_Div8);	//选择外部时钟，将 72MHz 的频率 8 分频，把系统嘀嗒定时器的变化定位在 1ms</span><br><span class="line">	raload = SystemCoreClock / 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void delay_ms(u16 t)</span><br><span class="line">&#123;	</span><br><span class="line">	//SysTick-&gt;CTRL &amp;=~ (1&lt;&lt;2);//选择时钟源--进行AHB 8分频</span><br><span class="line">	//SysTick-&gt;CTRL &amp;=~ (1&lt;&lt;1);//使能定时器中断	</span><br><span class="line">	SysTick-&gt;LOAD = reload-1;//AHB是72MHz时，填入计数值；</span><br><span class="line">	SysTick-&gt;VAL=0x00; // 清空计数器</span><br><span class="line">	SysTick-&gt;CTRL |= (1&lt;&lt;0);//开启计数器；也可以用SysTick_CTRL_ENABLE_Msk	赋值</span><br><span class="line">	while((SysTick-&gt;CTRL&amp;(1&lt;&lt;16))==0);//判断计数器计数是否结束（CTRL的第16位）</span><br><span class="line">	SysTick-&gt;CTRL &amp;=~ (1&lt;&lt;0);//关闭计数器；</span><br><span class="line">	SysTick-&gt;VAL=0x00; // 清空计数器</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="基本定时器">基本定时器</h1>
<ul>
<li>16位递增计数器</li>
<li>16位预分频器</li>
<li>可用于触发DAC</li>
<li>在计数器溢出时，可产生中断/DMA请求</li>
<li></li>
</ul>
<h1 id="点亮第一个led灯">点亮第一个LED灯</h1>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f1xx_hal.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">SystemClock_Config</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">MX_GPIO_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  HAL_Init();                   <span class="comment">// 初始化HAL库</span></span><br><span class="line">  SystemClock_Config();         <span class="comment">// 配置系统时钟</span></span><br><span class="line">  MX_GPIO_Init();               <span class="comment">// 初始化GPIO</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">		HAL_GPIO_TogglePin(GPIOA,GPIO_PIN_8);<span class="comment">// 切换LED灯的状态</span></span><br><span class="line">		HAL_GPIO_TogglePin(GPIOD,GPIO_PIN_2);</span><br><span class="line">		HAL_Delay(<span class="number">500</span>);<span class="comment">// 延时500ms</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">MX_GPIO_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStruct=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 开启GPIOA时钟</span></span><br><span class="line">	__HAL_RCC_GPIOA_CLK_ENABLE();</span><br><span class="line">	__HAL_RCC_GPIOD_CLK_ENABLE();</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//设置PA8,PD2为高速推挽输出</span></span><br><span class="line">	GPIO_InitStruct.Pin=GPIO_PIN_8;</span><br><span class="line">	GPIO_InitStruct.Mode=GPIO_MODE_OUTPUT_PP;</span><br><span class="line">	GPIO_InitStruct.Speed=GPIO_SPEED_FREQ_HIGH;</span><br><span class="line">	HAL_GPIO_Init(GPIOA,&amp;GPIO_InitStruct);</span><br><span class="line">	</span><br><span class="line">	GPIO_InitStruct.Pin=GPIO_PIN_2;</span><br><span class="line">	HAL_GPIO_Init(GPIOD,&amp;GPIO_InitStruct);</span><br><span class="line">    </span><br><span class="line">  	<span class="comment">// 初始状态关闭LED灯</span></span><br><span class="line">	HAL_GPIO_WritePin(GPIOA,GPIO_PIN_8,GPIO_PIN_SET);</span><br><span class="line">	HAL_GPIO_WritePin(GPIOD,GPIO_PIN_2,GPIO_PIN_SET);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">SystemClock_Config</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  RCC_OscInitTypeDef RCC_OscInitStruct = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  RCC_ClkInitTypeDef RCC_ClkInitStruct = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启用外部晶振</span></span><br><span class="line">  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;</span><br><span class="line">  RCC_OscInitStruct.HSEState = RCC_HSE_ON;</span><br><span class="line">  RCC_OscInitStruct.HSEPredivValue = RCC_HSE_PREDIV_DIV1;</span><br><span class="line">  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;</span><br><span class="line">  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;</span><br><span class="line">  RCC_OscInitStruct.PLL.PLLMUL = RCC_PLL_MUL9;</span><br><span class="line">  <span class="keyword">if</span> (HAL_RCC_OscConfig(&amp;RCC_OscInitStruct) != HAL_OK)</span><br><span class="line">  &#123;</span><br><span class="line">    Error_Handler();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置系统时钟</span></span><br><span class="line">  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_SYSCLK |</span><br><span class="line">                                RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2;</span><br><span class="line">  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;</span><br><span class="line">  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;</span><br><span class="line">  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;</span><br><span class="line">  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;</span><br><span class="line">  <span class="keyword">if</span> (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)</span><br><span class="line">  &#123;</span><br><span class="line">    Error_Handler();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Error_Handler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 出错处理函数</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="按键改变小灯亮灭">按键改变小灯亮灭</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;stm32f1xx_hal.h&quot;</span><br><span class="line"></span><br><span class="line">void SystemClock_Config(void);</span><br><span class="line">static void MX_GPIO_Init(void);</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">  HAL_Init();                   // 初始化HAL库</span><br><span class="line">  SystemClock_Config();         // 配置系统时钟</span><br><span class="line">  MX_GPIO_Init();               // 初始化GPIO</span><br><span class="line"></span><br><span class="line">  while (1)</span><br><span class="line">  &#123;</span><br><span class="line">  	if(HAL_GPIO_ReadPin(GPIOA,GPIO_PIN_15)==GPIO_PIN_RESET)&#123;</span><br><span class="line">			HAL_GPIO_WritePin(GPIOA,GPIO_PIN_8,GPIO_PIN_RESET);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			HAL_GPIO_WritePin(GPIOA,GPIO_PIN_8,GPIO_PIN_SET);</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static void MX_GPIO_Init(void)</span><br><span class="line">&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStruct=&#123;0&#125;;</span><br><span class="line">	</span><br><span class="line">    // 开启GPIOA时钟</span><br><span class="line">	__HAL_RCC_GPIOA_CLK_ENABLE();</span><br><span class="line">	</span><br><span class="line">    //设置PA8为高速推挽输出</span><br><span class="line">	GPIO_InitStruct.Pin=GPIO_PIN_8;</span><br><span class="line">	GPIO_InitStruct.Mode=GPIO_MODE_OUTPUT_PP;</span><br><span class="line">	GPIO_InitStruct.Speed=GPIO_SPEED_FREQ_HIGH;</span><br><span class="line">	HAL_GPIO_Init(GPIOA,&amp;GPIO_InitStruct);</span><br><span class="line">	</span><br><span class="line">	//设置PA15为上拉输入，PA15按下为低电平，松开为高电平</span><br><span class="line">	GPIO_InitStruct.Pin=GPIO_PIN_15;</span><br><span class="line">	GPIO_InitStruct.Mode=GPIO_MODE_INPUT;</span><br><span class="line">	GPIO_InitStruct.Pull=GPIO_PULLUP;</span><br><span class="line">	HAL_GPIO_Init(GPIOA,&amp;GPIO_InitStruct);	</span><br><span class="line">    </span><br><span class="line">  	// 初始状态关闭LED灯</span><br><span class="line">	HAL_GPIO_WritePin(GPIOA,GPIO_PIN_8,GPIO_PIN_SET);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void SystemClock_Config(void)</span><br><span class="line">&#123;</span><br><span class="line">  RCC_OscInitTypeDef RCC_OscInitStruct = &#123;0&#125;;</span><br><span class="line">  RCC_ClkInitTypeDef RCC_ClkInitStruct = &#123;0&#125;;</span><br><span class="line"></span><br><span class="line">  // 启用外部晶振</span><br><span class="line">  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;</span><br><span class="line">  RCC_OscInitStruct.HSEState = RCC_HSE_ON;</span><br><span class="line">  RCC_OscInitStruct.HSEPredivValue = RCC_HSE_PREDIV_DIV1;</span><br><span class="line">  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;</span><br><span class="line">  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;</span><br><span class="line">  RCC_OscInitStruct.PLL.PLLMUL = RCC_PLL_MUL9;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // 配置系统时钟</span><br><span class="line">  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_SYSCLK |</span><br><span class="line">                                RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2;</span><br><span class="line">  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;</span><br><span class="line">  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;</span><br><span class="line">  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;</span><br><span class="line">  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">点灯：</span><br><span class="line">灯亮</span><br><span class="line">while(1);</span><br><span class="line"></span><br><span class="line">灯闪烁：</span><br><span class="line">while(1)&#123;</span><br><span class="line">	灯亮</span><br><span class="line">    延时1s</span><br><span class="line">    灯灭</span><br><span class="line">    延时1s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">按键点灯：按下按键时，灯亮，松开按键时，灯灭</span><br><span class="line">while(1)&#123;</span><br><span class="line">	if 按键是按下的</span><br><span class="line">		灯亮</span><br><span class="line">	else</span><br><span class="line">		灯灭</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">按键点灯：按下按键时，灯亮，再次按下按键，灯灭</span><br><span class="line">while(1)&#123;</span><br><span class="line">	if 按键是按下的</span><br><span class="line">		翻转灯亮灭</span><br><span class="line">		while(按键没有松开)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">消抖按键点灯：按下按键时，灯亮，再次按下按键，灯灭</span><br><span class="line">while(1)&#123;</span><br><span class="line">	if 按键是按下的</span><br><span class="line">		延时一段时间</span><br><span class="line">		if 按键还是按下的</span><br><span class="line">            翻转灯亮灭</span><br><span class="line">            while(按键没有松开)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/blog/14.html" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    tm1637
                
            </div>
        </a>
    
    
        <a href="/blog/4.html" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">IIC</div>
        </a>
    
</nav>





    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     



    <section id="comments" class="comments">
      <style>
      .comments{margin:30px;padding:10px;background:rgb(0, 0, 0); }
      @media screen and (max-width:800px){.comments{margin:auto;padding:10px;background:#000}}
      </style>
      <div id="vcomment" class="comment"></div> 
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
   var notify = 'false' == true ? true : false;
   var verify = 'false' == true ? true : false;
    window.onload = function() {
        new Valine({
            el: '.comment',
            notify: notify,
            verify: verify,
            app_id: "CTNoKbqpycPjrAfvV5WOUgn9-gzGzoHsz",
            app_key: "4xi8kYb4IZ7eiT08B6SQmDao",
            placeholder: "Just go go",
            avatar:"mm"
        });
    }
</script>
    </section>
  
  ]=p;o0l-</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            晴语 &copy; 2023 
            <a rel="external nofollow noopener noreferrer" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        

    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>